define("core_message/message_area_messages",["jquery","core/ajax","core/templates","core/notification","core/custom_interaction_events","core/auto_rows","core_message/message_area_actions","core/modal_factory","core/modal_events","core/str","core_message/message_area_events","core/backoff_timer"],function(a,b,c,d,e,f,g,h,i,j,k,l){var n=500,o={BLOCKTIME:"[data-region='blocktime']",CANCELDELETEMESSAGES:"[data-action='cancel-delete-messages']",CONTACT:"[data-region='contact']",CONVERSATIONS:"[data-region='contacts'][data-region-content='conversations']",DELETEALLMESSAGES:"[data-action='delete-all-messages']",DELETEMESSAGES:"[data-action='delete-messages']",LOADINGICON:".loading-icon",MESSAGE:"[data-region='message']",MESSAGERESPONSE:"[data-region='response']",MESSAGES:"[data-region='messages']",MESSAGESAREA:"[data-region='messages-area']",MESSAGINGAREA:"[data-region='messaging-area']",SENDMESSAGE:"[data-action='send-message']",SENDMESSAGETEXT:"[data-region='send-message-txt']",SHOWCONTACTS:"[data-action='show-contacts']",STARTDELETEMESSAGES:"[data-action='start-delete-messages']"},p=1e3;function m(a){this.messageArea=a;this._init()}m.prototype._isSendingMessage=!1;m.prototype._isLoadingMessages=!1;m.prototype._numMessagesDisplayed=0;m.prototype._messageQueue=[];m.prototype._numMessagesToRetrieve=20;m.prototype._confirmationModal=null;m.prototype._latestMessageTimestamp=0;m.prototype._backoffTimer=null;m.prototype.messageArea=null;m.prototype._init=function(){e.define(this.messageArea.node,[e.events.activate,e.events.up,e.events.down,e.events.enter]);if(670>=a(window).height()){n=400}f.init(this.messageArea.node);this.messageArea.onCustomEvent(k.CONVERSATIONSELECTED,this._viewMessages.bind(this));this.messageArea.onCustomEvent(k.SENDMESSAGE,this._viewMessages.bind(this));this.messageArea.onCustomEvent(k.CHOOSEMESSAGESTODELETE,this._chooseMessagesToDelete.bind(this));this.messageArea.onCustomEvent(k.CANCELDELETEMESSAGES,this._hideDeleteAction.bind(this));this.messageArea.onDelegateEvent(e.events.activate,o.SENDMESSAGE,this._sendMessage.bind(this));this.messageArea.onDelegateEvent(e.events.activate,o.STARTDELETEMESSAGES,this._startDeleting.bind(this));this.messageArea.onDelegateEvent(e.events.activate,o.DELETEMESSAGES,this._deleteMessages.bind(this));this.messageArea.onDelegateEvent(e.events.activate,o.DELETEALLMESSAGES,this._deleteAllMessages.bind(this));this.messageArea.onDelegateEvent(e.events.activate,o.CANCELDELETEMESSAGES,this._triggerCancelMessagesToDelete.bind(this));this.messageArea.onDelegateEvent(e.events.activate,o.MESSAGE,this._toggleMessage.bind(this));this.messageArea.onDelegateEvent(e.events.activate,o.SHOWCONTACTS,this._hideMessagingArea.bind(this));this.messageArea.onDelegateEvent(e.events.up,o.MESSAGE,this._selectPreviousMessage.bind(this));this.messageArea.onDelegateEvent(e.events.down,o.MESSAGE,this._selectNextMessage.bind(this));this.messageArea.onDelegateEvent("focus",o.SENDMESSAGETEXT,this._setMessaging.bind(this));this.messageArea.onDelegateEvent("blur",o.SENDMESSAGETEXT,this._clearMessaging.bind(this));a(document).on(f.events.ROW_CHANGE,this._adjustMessagesAreaHeight.bind(this));var b=this.messageArea.find(o.MESSAGES);if(b.length){this._addScrollEventListener(b.find(o.MESSAGE).length);this._latestMessageTimestamp=b.find(o.MESSAGE+":last").data("timecreated")}this._backoffTimer=new l(this._loadNewMessages.bind(this),l.getIncrementalCallback(this.messageArea.pollmin*p,p,this.messageArea.pollmax*p,this.messageArea.polltimeout*p));this._backoffTimer.start()};m.prototype._viewMessages=function(e,f){this._numMessagesDisplayed=0;this._backoffTimer.stop();this._latestMessageTimestamp=0;var g=b.call([{methodname:"core_message_mark_all_messages_as_read",args:{useridto:this.messageArea.getCurrentUserId(),useridfrom:f}}]),h=0;return c.render("core/loading",{}).then(function(a,b){c.replaceNodeContents(this.messageArea.find(o.MESSAGESAREA),a,b);return g[0]}.bind(this)).then(function(){var b=this.messageArea.find(o.CONVERSATIONS+" "+o.CONTACT+"[data-userid='"+f+"']");if(b.hasClass("unread")){b.removeClass("unread");a(document).trigger("messagearea:conversationselected",f)}return this._getMessages(f)}.bind(this)).then(function(a){h=a.messages.length;return c.render("core_message/message_area_messages_area",a)}).then(function(a,b){c.replaceNodeContents(this.messageArea.find(o.MESSAGESAREA),a,b);this._addScrollEventListener(h);this._backoffTimer.restart();this.messageArea.find(o.SENDMESSAGETEXT).focus()}.bind(this)).fail(d.exception)};m.prototype._loadMessages=function(){if(this._isLoadingMessages){return!1}this._isLoadingMessages=!0;var b=0;return c.render("core/loading",{}).then(function(a,b){c.prependNodeContents(this.messageArea.find(o.MESSAGES),"<div style='text-align:center'>"+a+"</div>",b);return this._getMessages(this._getUserId())}.bind(this)).then(function(a){b=a.messages.length;return c.render("core_message/message_area_messages",a)}).then(function(d,e){this.messageArea.find(o.MESSAGES+" "+o.LOADINGICON).remove();if(0<b){var f=a("<div>"+d+"</div>");if(this._hasMatchingBlockTime(this.messageArea.node,f,!0)){this.messageArea.node.find(o.BLOCKTIME+":first").remove()}var g=this.messageArea.find(o.MESSAGES)[0].scrollHeight;c.prependNodeContents(this.messageArea.find(o.MESSAGES),d,e);var h=this.messageArea.find(o.MESSAGES)[0].scrollHeight;this.messageArea.find(o.MESSAGES).scrollTop(h-g);this._numMessagesDisplayed+=b}this._isLoadingMessages=!1}.bind(this)).fail(d.exception)};m.prototype._loadNewMessages=function(){if(this._isLoadingMessages){return!1}if(!this._getUserId()){return!1}this._isLoadingMessages=!0;var a=!1,b=this.messageArea.find(o.MESSAGES);if(0!==b.length){var c=b.scrollTop(),e=b.innerHeight(),f=b[0].scrollHeight;if(c+e>=f){a=!0}}return this._getMessages(this._getUserId(),!0).then(function(b){return this._addMessagesToDom(b.messages,a)}.bind(this)).always(function(){this._isLoadingMessages=!1}.bind(this)).fail(d.exception)};m.prototype._getMessages=function(a,c){var e={currentuserid:this.messageArea.getCurrentUserId(),otheruserid:a,limitfrom:this._numMessagesDisplayed,limitnum:this._numMessagesToRetrieve,newest:!0};if(c){e.timefrom=this._latestMessageTimestamp;e.limitfrom=0;e.limitnum=0}var f=b.call([{methodname:"core_message_data_for_messagearea_messages",args:e}]);return f[0].then(function(a){var b=a.messages;if(b&&b.length){var c=b[b.length-1];if(c.timecreated>this._latestMessageTimestamp){this._latestMessageTimestamp=c.timecreated+1}}return a}.bind(this)).fail(function(a){this._backoffTimer.stop();d.exception(a)}.bind(this))};m.prototype._sendMessage=function(){var a=this.messageArea.find(o.SENDMESSAGETEXT),c=a.val().trim();if(""===c){return!1}if(this._isSendingMessage){return!1}this._isSendingMessage=!0;var e=b.call([{methodname:"core_message_send_instant_messages",args:{messages:[{touserid:this._getUserId(),text:c}]}}]);a.prop("disabled",!0);return e[0].then(function(a){if(0>a.length){throw new Error("Invalid response")}if(a[0].errormessage){throw new Error(a[0].errormessage)}this.messageArea.trigger(k.MESSAGESENT,[this._getUserId(),c]);return this._addLastMessageToDom()}.bind(this)).then(function(){this._isSendingMessage=!1}.bind(this)).always(function(){a.prop("disabled",!1);a.focus()}).fail(d.exception)};m.prototype._chooseMessagesToDelete=function(){this.messageArea.find(o.MESSAGESAREA).addClass("editing");this.messageArea.find(o.MESSAGE).attr("role","checkbox").attr("aria-checked","false")};m.prototype._deleteMessages=function(){var c=this.messageArea.getCurrentUserId(),e=this.messageArea.find(o.MESSAGE+"[aria-checked='true']"),f=[],g=[];e.each(function(b,d){var e=a(d),h=e.data("messageid"),i=e.data("messageread")?1:0;g.push(e);f.push({methodname:"core_message_delete_message",args:{messageid:h,userid:c,read:i}})});if(0<f.length){a.when(b.call(f)).then(function(){var b=null,c=this.messageArea.find(o.MESSAGE),d=c.last(),e=g[g.length-1];a.each(g,function(a,b){b.remove()});if(d.data("id")===e.data("id")){b=this.messageArea.find(o.MESSAGE).last()}a.each(g,function(a,b){var c=b.data("blocktime");if(0===this.messageArea.find(o.MESSAGE+"[data-blocktime='"+c+"']").length){this.messageArea.find(o.BLOCKTIME+"[data-blocktime='"+c+"']").remove()}}.bind(this));if(0===this.messageArea.find(o.MESSAGE).length){this.messageArea.find(o.CONVERSATIONS+" "+o.CONTACT+"[data-userid='"+this._getUserId()+"']").remove()}this.messageArea.trigger(k.MESSAGESDELETED,[this._getUserId(),b])}.bind(this)).catch(d.exception)}else{this.messageArea.trigger(k.MESSAGESDELETED,this._getUserId())}this._hideDeleteAction()};m.prototype._addScrollEventListener=function(a){this._scrollBottom();this._numMessagesDisplayed=a;e.define(this.messageArea.find(o.MESSAGES),[e.events.scrollTop]);this.messageArea.onCustomEvent(e.events.scrollTop,this._loadMessages.bind(this))};m.prototype._deleteAllMessages=function(){if(this._confirmationModal){this._confirmationModal.show();return}var c=j.get_strings([{key:"confirm"},{key:"deleteallconfirm",component:"message"},{key:"delete"}]),e=h.create({type:h.types.SAVE_CANCEL},this.messageArea.find(o.DELETEALLMESSAGES));a.when(c,e).then(function(a,c){c.setTitle(a[0]);c.setBody(a[1]);c.setSaveButtonText(a[2]);this._confirmationModal=c;c.getRoot().on(i.save,function(){var a=this._getUserId(),c={methodname:"core_message_delete_conversation",args:{userid:this.messageArea.getCurrentUserId(),otheruserid:a}};b.call([c])[0].then(function(){this.messageArea.find(o.MESSAGESAREA).empty();this.messageArea.trigger(k.CONVERSATIONDELETED,a);this._hideDeleteAction()}.bind(this)).catch(d.exception)}.bind(this));c.show()}.bind(this)).catch(d.exception)};m.prototype._hideDeleteAction=function(){this.messageArea.find(o.MESSAGE).removeAttr("role").removeAttr("aria-checked");this.messageArea.find(o.MESSAGESAREA).removeClass("editing")};m.prototype._triggerCancelMessagesToDelete=function(){this.messageArea.trigger(k.CANCELDELETEMESSAGES)};m.prototype._addMessagesToDom=function(b,d){var e=0,f=this.messageArea.find(o.MESSAGES);b=b.filter(function(a){var b=""+a.id+a.isread;if(this._messageQueue[b]){return!1}var c=f.find(o.MESSAGE+"[data-id=\""+b+"\"]");if(!c.length){this._messageQueue[b]=!0}return!c.length}.bind(this));e=b.length;return c.render("core_message/message_area_messages",{messages:b}).then(function(b,f){if(0<e){var g=a("<div>"+b+"</div>");if(this._hasMatchingBlockTime(this.messageArea.node,g,!1)){g.find(o.BLOCKTIME+":first").remove()}c.appendNodeContents(this.messageArea.find(o.MESSAGES),g,f);if(d){this._scrollBottom()}this._numMessagesDisplayed+=e;this._backoffTimer.restart()}}.bind(this))};m.prototype._addLastMessageToDom=function(){var a=b.call([{methodname:"core_message_data_for_messagearea_get_most_recent_message",args:{currentuserid:this.messageArea.getCurrentUserId(),otheruserid:this._getUserId()}}]);return a[0].then(function(a){return this._addMessagesToDom([a],!0)}.bind(this)).always(function(){this.messageArea.find(o.SENDMESSAGETEXT).val("").trigger("input")}.bind(this)).fail(d.exception)};m.prototype._getUserId=function(){return this.messageArea.find(o.MESSAGES).data("userid")};m.prototype._scrollBottom=function(){var a=this.messageArea.find(o.MESSAGES);if(0!==a.length){a.scrollTop(a[0].scrollHeight)}};m.prototype._selectPreviousMessage=function(b,c){var d=a(b.target).closest(o.MESSAGE);do{d=d.prev()}while(d.length&&!d.is(o.MESSAGE));d.focus();c.originalEvent.preventDefault();c.originalEvent.stopPropagation()};m.prototype._selectNextMessage=function(b,c){var d=a(b.target).closest(o.MESSAGE);do{d=d.next()}while(d.length&&!d.is(o.MESSAGE));d.focus();c.originalEvent.preventDefault();c.originalEvent.stopPropagation()};m.prototype._setMessaging=function(b){a(b.target).closest(o.MESSAGERESPONSE).addClass("messaging")};m.prototype._clearMessaging=function(b){a(b.target).closest(o.MESSAGERESPONSE).removeClass("messaging")};m.prototype._startDeleting=function(a){var b=new g(this.messageArea);b.chooseMessagesToDelete();a.preventDefault()};m.prototype._isEditing=function(){return this.messageArea.find(o.MESSAGESAREA).hasClass("editing")};m.prototype._toggleMessage=function(b){if(!this._isEditing()){return}var c=a(b.target).closest(o.MESSAGE);if("true"===c.attr("aria-checked")){c.attr("aria-checked","false")}else{c.attr("aria-checked","true")}};m.prototype._adjustMessagesAreaHeight=function(){var a=this.messageArea.find(o.MESSAGES),b=this.messageArea.find(o.MESSAGERESPONSE),c=b.outerHeight(),d=n-(c-50);a.outerHeight(d)};m.prototype._sendMessageHandler=function(a,b){b.originalEvent.preventDefault();this._sendMessage()};m.prototype._hideMessagingArea=function(){this.messageArea.find(o.MESSAGINGAREA).removeClass("show-messages").addClass("hide-messages")};m.prototype._hasMatchingBlockTime=function(a,b,c){var d,e,f,g;if(c){e=":first";g=":last"}else{e=":last";g=":first"}d=a.find(o.BLOCKTIME+e);f=b.find(o.BLOCKTIME+g);if(d.length&&f.length){return d.data("blocktime")==f.data("blocktime")}return!1};return m});
//# sourceMappingURL=message_area_messages.min.js.map
