function _typeof(a){if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define("core_message/message_drawer_view_conversation",["jquery","core/auto_rows","core/backoff_timer","core/custom_interaction_events","core/notification","core/pubsub","core/str","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_view_conversation_constants","core_message/message_drawer_view_conversation_patcher","core_message/message_drawer_view_conversation_renderer","core_message/message_drawer_view_conversation_state_manager","core_message/message_drawer_router","core_message/message_drawer_routes"],function(a,b,c,d,f,e,g,h,i,j,k,l,m,n,o){var p={},q=null,r=!1,s=0,t=null,u=!0,v=!1,w=null,x=j.NEWEST_MESSAGES_FIRST,y=j.LOAD_MESSAGE_LIMIT,z=j.INITIAL_NEW_MESSAGE_POLL_TIMEOUT,A=j.SELECTORS,B=j.CONVERSATION_TYPES,C=function(){if(!q||q.type!=B.PRIVATE){return null}var a=q.loggedInUserId,b=Object.keys(q.members).filter(function(b){return a!=b});return b.length?b[0]:null},D=function(a){return Object.keys(p).reduce(function(b,c){if(!b){var d=p[c].state;if(d.type==B.PRIVATE){if(a in d.members){b=d.id}}}return b},null)},E=function(a){return{id:parseInt(a.attr("data-user-id"),10),fullname:null,profileimageurl:null,profileimageurlsmall:null,isonline:null,showonlinestatus:null,isblocked:null,iscontact:null,isdeleted:null,canmessage:null,requirescontact:null,contactrequests:[]}},F=function(){return s},G=function(a){s=a;p[q.id].messagesOffset=a},H=function(){return r},I=function(a){r=a;p[q.id].loadedAllMessages=a},J=function(a){return a.find(A.MESSAGES_CONTAINER)},K=function(b){return{id:b.id,name:b.name,subname:b.subname,imageUrl:b.imageUrl,isFavourite:b.isFavourite,type:b.type,totalMemberCount:b.totalMemberCount,loggedInUserId:b.loggedInUserId,messages:b.messages.map(function(b){return a.extend({},b)}),members:Object.keys(b.members).reduce(function(c,d){c[d]=a.extend({},b.members[d]);c[d].contactrequests=b.members[d].contactrequests.map(function(b){return a.extend({},b)});return c},{})}},L=function(a,b){var c=a.id,d=m.setLoadingMembers(q,!0);d=m.setLoadingMessages(d,!0);return w(d).then(function(){return h.getMemberInfo(c,[b],!0,!0)}).then(function(a){if(a.length){return a[0]}else{throw new Error("Unable to load other user profile")}}).then(function(b){var c=m.addMembers(q,[b,a]);c=m.setLoadingMembers(c,!1);c=m.setLoadingMessages(c,!1);c=m.setName(c,b.fullname);c=m.setType(c,1);c=m.setImageUrl(c,b.profileimageurl);c=m.setTotalMemberCount(c,2);return w(c).then(function(){return b})}).catch(function(a){var b=m.setLoadingMembers(q,!1);w(b);f.exception(a)})},M=function(a,b){var c=a.members.filter(function(a){return a.id!=b}),d=c.length?c[0]:null,e=a.name,f=a.imageurl;if(a.type==B.PRIVATE){e=e||d?d.fullname:"";f=f||d?d.profileimageurl:""}var g=m.addMembers(q,a.members);g=m.setName(g,e);g=m.setSubname(g,a.subname);g=m.setType(g,a.type);g=m.setImageUrl(g,f);g=m.setTotalMemberCount(g,a.membercount);g=m.setIsFavourite(g,a.isfavourite);g=m.addMessages(g,a.messages);return g},N=function(a,b,c,d,e){var g=b.id,i=m.setLoadingMembers(q,!0);i=m.setLoadingMessages(i,!0);return w(i).then(function(){return h.getConversation(g,a,!0,!0,0,0,c+1,d,e)}).then(function(a){if(a.messages.length>c){a.messages=a.messages.slice(1)}else{I(!0)}G(d+c);return a}).then(function(a){var c=a.members.filter(function(a){return a.id==b.id});if(1>c.length){a.members=a.members.concat([b])}var d=M(a,b.id);d=m.setLoadingMembers(d,!1);d=m.setLoadingMessages(d,!1);return w(d).then(function(){return a})}).then(function(){return R(a)}).catch(function(a){var b=m.setLoadingMembers(q,!1);b=m.setLoadingMessages(b,!1);w(b);f.exception(a)})},O=function(a,b,c,d){var e=a.members.filter(function(a){return a.id==b.id});if(1>e.length){a.members=a.members.concat([b])}var g=M(a,b.id);g=m.setLoadingMembers(g,!1);g=m.setLoadingMessages(g,!0);var h=a.messages.length;return w(g).then(function(){if(h<c){return P(a.id,c,h,d,[]).then(function(a){return a.messages})}else{var b=m.setLoadingMessages(q,!1);return w(b).then(function(){return a.messages})}}).then(function(a){G(a.length);return a}).then(function(){return R(a.id)}).catch(f.exception)},P=function(a,b,c,d,e,f){return h.getMessages(q.loggedInUserId,a,b?b+1:b,c,d,f).then(function(a){if(a.messages.length&&e.length){a.messages=a.messages.filter(function(a){return 0>e.indexOf(parseInt(a.id,10))})}return a}).then(function(a){if(!b){return a}else if(a.messages.length>b){a.messages=a.messages.slice(0,-1)}else{I(!0)}return a}).then(function(a){var b=a.members.filter(function(a){return!(a.id in q.members)}),c=m.addMembers(q,b);c=m.addMessages(c,a.messages);c=m.setLoadingMessages(c,!1);return w(c).then(function(){return a})}).catch(function(a){var b=m.setLoadingMessages(q,!1);w(b);throw a})},Q=function(b,c){return function(){var d=q.messages,f=d.length?d[d.length-1]:null;if(f&&!u&&!v){for(var g=[],h=d.length-1,j;0<=h;h--){j=d[h];if(j.timeCreated===f.timeCreated){g.push(j.id)}else{break}}return P(b,0,0,c,g,f.timeCreated).then(function(a){if(a.messages.length){t.restart();var c=K(q);e.publish(i.CONVERSATION_NEW_LAST_MESSAGE,c);return R(b)}else{return a}})}return a.Deferred().resolve().promise()}},R=function(a){var b=q.loggedInUserId;return h.markAllConversationMessagesAsRead(b,a).then(function(){var b=m.markMessagesAsRead(q,q.messages);e.publish(i.CONVERSATION_READ,a);return w(b)})},S=function(a){return da(a).then(function(){var b=m.addPendingBlockUsersById(q,[a]);return w(b)})},T=function(a){var b=m.setLoadingConfirmAction(q,!0);return w(b).then(function(){return h.blockUser(q.loggedInUserId,a)}).then(function(b){var c=m.addMembers(q,[b]);c=m.removePendingBlockUsersById(c,[a]);c=m.setLoadingConfirmAction(c,!1);e.publish(i.CONTACT_BLOCKED,a);return w(c)})},U=function(a){return da(a).then(function(){var b=m.addPendingUnblockUsersById(q,[a]);return w(b)})},V=function(a){var b=m.setLoadingConfirmAction(q,!0);return w(b).then(function(){return h.unblockUser(q.loggedInUserId,a)}).then(function(b){var c=m.addMembers(q,[b]);c=m.removePendingUnblockUsersById(c,[a]);c=m.setLoadingConfirmAction(c,!1);e.publish(i.CONTACT_UNBLOCKED,a);return w(c)})},W=function(a){return da(a).then(function(){var b=m.addPendingRemoveContactsById(q,[a]);return w(b)})},X=function(a){var b=m.setLoadingConfirmAction(q,!0);return w(b).then(function(){return h.deleteContacts(q.loggedInUserId,[a])}).then(function(b){var c=m.addMembers(q,b);c=m.removePendingRemoveContactsById(c,[a]);c=m.setLoadingConfirmAction(c,!1);e.publish(i.CONTACT_REMOVED,a);return w(c)})},Y=function(a){return da(a).then(function(){var b=m.addPendingAddContactsById(q,[a]);return w(b)})},Z=function(a){var b=m.setLoadingConfirmAction(q,!0);return w(b).then(function(){return h.createContactRequest(q.loggedInUserId,a)}).then(function(a){if(!a.request){throw new Error(a.warnings[0].message)}return a.request}).then(function(b){var c=m.removePendingAddContactsById(q,[a]);c=m.addContactRequests(c,[b]);c=m.setLoadingConfirmAction(c,!1);return w(c)})},$=function(){var a=q.loggedInUserId,b=q.id;return h.setFavouriteConversations(a,[b]).then(function(){var a=m.setIsFavourite(q,!0);return w(a)}).then(function(){return e.publish(i.CONVERSATION_SET_FAVOURITE,K(q))})},_=function(){var a=q.loggedInUserId,b=q.id;return h.unsetFavouriteConversations(a,[b]).then(function(){var a=m.setIsFavourite(q,!1);return w(a)}).then(function(){return e.publish(i.CONVERSATION_UNSET_FAVOURITE,K(q))})},aa=function(a){var b=q.selectedMessageIds;return da(a).then(function(){var a=m.addPendingDeleteMessagesById(q,b);return w(a)})},ba=function(){var a=q.pendingDeleteMessageIds,b=m.setLoadingConfirmAction(q,!0);return w(b).then(function(){return h.deleteMessages(q.loggedInUserId,a)}).then(function(){var b=m.removeMessagesById(q,a);b=m.removePendingDeleteMessagesById(b,a);b=m.removeSelectedMessagesById(b,a);b=m.setLoadingConfirmAction(b,!1);var c=q.messages[q.messages.length-1],d=b.messages.length?b.messages[b.messages.length-1]:null;if(d&&d.id!=c.id){var f=K(b);e.publish(i.CONVERSATION_NEW_LAST_MESSAGE,f)}else if(!b.messages.length){e.publish(i.CONVERSATION_DELETED,b.id)}return w(b)})},ca=function(){var a=m.setLoadingConfirmAction(q,!0);return w(a).then(function(){return h.deleteConversation(q.loggedInUserId,q.id)}).then(function(){var a=m.removeMessages(q,q.messages);a=m.removeSelectedMessagesById(a,q.selectedMessageIds);a=m.setPendingDeleteConversation(a,!1);a=m.setLoadingConfirmAction(a,!1);e.publish(i.CONVERSATION_DELETED,a.id);return w(a)})},da=function(a){var b=q.pendingDeleteMessageIds,c=m.removePendingAddContactsById(q,[a]);c=m.removePendingRemoveContactsById(c,[a]);c=m.removePendingUnblockUsersById(c,[a]);c=m.removePendingBlockUsersById(c,[a]);c=m.removePendingDeleteMessagesById(c,b);c=m.setPendingDeleteConversation(c,!1);return w(c)},ea=function(a){var b=q.loggedInUserId,c=q.members[a].contactrequests.filter(function(a){return a.requesteduserid==b}),d=c[0],f=m.setLoadingConfirmAction(q,!0);return w(f).then(function(){return h.acceptContactRequest(a,b)}).then(function(a){var b=m.removeContactRequests(q,[d]);b=m.addMembers(q,[a]);b=m.setLoadingConfirmAction(b,!1);return w(b)}).then(function(){e.publish(i.CONTACT_ADDED,q.members[a]);e.publish(i.CONTACT_REQUEST_ACCEPTED,d)})},fa=function(a){var b=q.loggedInUserId,c=q.members[a].contactrequests.filter(function(a){return a.requesteduserid==b}),d=c[0],f=m.setLoadingConfirmAction(q,!0);return w(f).then(function(){return h.declineContactRequest(a,b)}).then(function(a){var b=m.removeContactRequests(q,[d]);b=m.addMembers(q,[a]);b=m.setLoadingConfirmAction(b,!1);return w(b)}).then(function(){e.publish(i.CONTACT_REQUEST_DECLINED,d)})},ga=function(a,b){v=!0;var c=m.setSendingMessage(q,!0),d=null;return w(c).then(function(){if(!a&&q.type==B.PRIVATE){var c=C();return h.sendMessageToUser(c,b).then(function(a){d=parseInt(a.conversationid,10);return a})}else{return h.sendMessageToConversation(a,b)}}).then(function(a){var b=m.addMessages(q,[a]);b=m.setSendingMessage(b,!1);var c=K(b);if(!b.id){b=m.setId(b,d);c.id=d;sa(d);e.publish(i.CONVERSATION_CREATED,c)}return w(b).then(function(){v=!1;e.publish(i.CONVERSATION_NEW_LAST_MESSAGE,c)})}).catch(function(a){v=!1;var b=m.setSendingMessage(q,!1);w(b);f.exception(a)})},ha=function(a){var b=q;if(-1<q.selectedMessageIds.indexOf(a)){b=m.removeSelectedMessagesById(q,[a])}else{b=m.addSelectedMessagesById(q,[a])}return w(b)},ia=function(){return da(C()).then(function(){var a=m.removeSelectedMessagesById(q,q.selectedMessageIds);return w(a)})},ja=function(a,b,c){return function(d){var e=k.buildPatch(q,d);return l.render(a,b,c,e).then(function(){q=d;if(d.id){p[d.id]={state:d,messagesOffset:F(),loadedAllMessages:H()}}})}},ka=function(a){return function(b,c){if(!q.loadingConfirmAction){a(C()).catch(function(a){var b=m.setLoadingConfirmAction(q,!1);w(b);f.exception(a)})}c.originalEvent.preventDefault()}},la=function(b,c){var d=a(b.target),e=d.closest(A.FOOTER_CONTAINER),f=e.find(A.MESSAGE_TEXT_AREA),g=f.val().trim();if(""!==g){ga(q.id,g)}c.originalEvent.preventDefault()},ma=function(a,b){var c=C(),d=q.members[c];n.go(o.VIEW_CONTACT,d);b.originalEvent.preventDefault()},na=function(a,b){n.go(o.VIEW_GROUP_INFO,{id:q.id,name:q.name,subname:q.subname,imageUrl:q.imageUrl,totalMemberCount:q.totalMemberCount},q.loggedInUserId);b.originalEvent.preventDefault()},oa=[[A.ACTION_REQUEST_BLOCK,ka(S)],[A.ACTION_REQUEST_UNBLOCK,ka(U)],[A.ACTION_REQUEST_ADD_CONTACT,ka(Y)],[A.ACTION_REQUEST_REMOVE_CONTACT,ka(W)],[A.ACTION_REQUEST_DELETE_CONVERSATION,ka(function b(a){return da(a).then(function(){var a=m.setPendingDeleteConversation(q,!0);return w(a)})})],[A.ACTION_CANCEL_EDIT_MODE,function c(a,b){ia().catch(f.exception);b.originalEvent.preventDefault()}],[A.ACTION_VIEW_CONTACT,ma],[A.ACTION_VIEW_GROUP_INFO,na],[A.ACTION_CONFIRM_FAVOURITE,function c(a,b){$().catch(f.exception);b.originalEvent.preventDefault()}],[A.ACTION_CONFIRM_UNFAVOURITE,function c(a,b){_().catch(f.exception);b.originalEvent.preventDefault()}]],pa=[[A.ACTION_CANCEL_CONFIRM,ka(da)],[A.ACTION_CONFIRM_BLOCK,ka(T)],[A.ACTION_CONFIRM_UNBLOCK,ka(V)],[A.ACTION_CONFIRM_ADD_CONTACT,ka(Z)],[A.ACTION_CONFIRM_REMOVE_CONTACT,ka(X)],[A.ACTION_CONFIRM_DELETE_SELECTED_MESSAGES,ka(ba)],[A.ACTION_CONFIRM_DELETE_CONVERSATION,ka(ca)],[A.ACTION_REQUEST_ADD_CONTACT,ka(Y)],[A.ACTION_ACCEPT_CONTACT_REQUEST,ka(ea)],[A.ACTION_DECLINE_CONTACT_REQUEST,ka(fa)],[A.MESSAGE,function i(b,c){var d=window.getSelection(),e=a(b.target);if(""!=d.toString()){return}if(e.is("a")){return}var g=e.closest(A.MESSAGE),h=parseInt(g.attr("data-message-id"),10);ha(h).catch(f.exception);c.originalEvent.preventDefault()}]],qa=[[A.SEND_MESSAGE_BUTTON,la],[A.ACTION_REQUEST_DELETE_SELECTED_MESSAGES,ka(aa)],[A.ACTION_REQUEST_ADD_CONTACT,ka(Y)],[A.ACTION_REQUEST_UNBLOCK,ka(U)]],ra=function(a,c,g){var h=!1,j=J(c);b.init(g);d.define(a,[d.events.activate]);d.define(c,[d.events.activate]);d.define(g,[d.events.activate,d.events.enter]);d.define(j,[d.events.scrollTop,d.events.scrollLock]);j.on(d.events.scrollTop,function(a,b){var c=1<Object.keys(q.members).length;if(!u&&!h&&!H()&&c){h=!0;var d=m.setLoadingMessages(q,!0);w(d).then(function(){return P(q.id,y,F(),x,[])}).then(function(){h=!1;G(F()+y)}).catch(function(a){h=!1;f.exception(a)})}b.originalEvent.preventDefault()});oa.forEach(function(b){var c=b[0],e=b[1];a.on(d.events.activate,c,e)});pa.forEach(function(a){var b=a[0],e=a[1];c.on(d.events.activate,b,e)});qa.forEach(function(a){var b=a[0],c=a[1];g.on(d.events.activate,b,c)});g.on(d.events.enter,A.MESSAGE_TEXT_AREA,function(a,b){var c=g.attr("data-enter-to-send");if(c&&"false"!=c&&"0"!=c){la(a,b)}});e.subscribe(i.ROUTE_CHANGED,function(a){if(t){if(a.route!=o.VIEW_CONVERSATION){t.stop()}}})},sa=function(a){if(t){t.stop()}t=new c(Q(a,x),function(a){if(!a){return z}return 2*a});t.start()},ta=function(a,b,c){var d=c.id,e=parseInt(a.attr("data-midnight"),10),f=m.buildInitialState(e,d,b);if(!q){q=f}if(t){t.stop()}return w(f)},ua=function(a,b,c){return ta(a,null,b).then(function(){return h.getConversationBetweenUsers(b.id,c,!0,!0,0,0,y,0,x).then(function(c){return wa(a,c,b)}).catch(function(){return L(b,c)})})},va=function(a,b,c){var d=null;if(b in p){d=p[b]}return ta(a,b,c).then(function(){if(d){var a=d.state;a=m.setLoadingMessages(a,!1);a=m.setLoadingMembers(a,!1);G(d.messagesOffset);I(d.loadedAllMessages);return w(a)}else{return N(b,c,y,0,x)}}).then(function(){return sa(b)})},wa=function(a,b,c){var d=null;if(b.id in p){d=p[b.id]}return ta(a,b.id,c).then(function(){if(d){var a=d.state;a=m.setLoadingMessages(a,!1);a=m.setLoadingMembers(a,!1);G(d.messagesOffset);I(d.loadedAllMessages);return w(a)}else{return O(b,c,y,x)}}).then(function(){return sa(b.id)})},xa=function(b,c,d,e,g,h){var i=null,k=null;if(e&&null!==e&&"object"==_typeof(e)){i=e;k=parseInt(i.id,10)}else{i=null;k=parseInt(e,10);k=isNaN(k)?null:k}if(!k&&g&&h){k=D(h)}if(!c.attr("data-init")){w=ja(b,c,d);ra(b,c,d);c.attr("data-init",!0)}var l=!q||q.id!=k||h&&h!=C();if(l){u=!0;var m=null,n=E(c);if(i){m=wa(c,i,n,h)}else if(k){m=va(c,k,n,h)}else{m=ua(c,n,h)}return m.then(function(){u=!1;b.find(j.SELECTORS.CAN_RECEIVE_FOCUS).first().focus()}).catch(function(a){u=!1;f.exception(a)})}sa(k);if(q.type==B.PRIVATE&&g){var o=C();switch(g){case"block":return S(o);case"unblock":return U(o);case"add-contact":return Y(o);case"remove-contact":return W(o);}}return a.Deferred().resolve().promise()},ya=function(){return g.get_string("messagedrawerviewconversation","core_message",q.name)};return{show:xa,description:ya}});
//# sourceMappingURL=message_drawer_view_conversation.es6.js.map
