{"version":3,"sources":["../src/message_drawer_router.js"],"names":["define","$","PubSub","Str","MessageDrawerEvents","routes","history","SELECTORS","CAN_RECEIVE_FOCUS","ROUTES_BACK","changeRoute","newRoute","newConfig","args","slice","call","arguments","renderPromise","Deferred","resolve","promise","Object","keys","forEach","route","config","isMatch","elements","element","removeClass","attr","addClass","onGo","apply","concat","currentFocusElement","document","activeElement","hasFocus","i","length","has","find","filter","first","focus","record","params","publish","ROUTE_CHANGED","go","inHistory","reduce","carry","previous","push","previousRecord","prevConfig","focusElement","getDescription","then","description","get_string","label","catch","back","pop","window","setTimeout","add"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A simple router for the message drawer that allows navigating between\n * the \"pages\" in the drawer.\n *\n * This module will maintain a linear history of the unique pages access\n * to allow navigating back.\n *\n * @module     core_message/message_drawer_router\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n[\n    'jquery',\n    'core/pubsub',\n    'core/str',\n    'core_message/message_drawer_events'\n],\nfunction(\n    $,\n    PubSub,\n    Str,\n    MessageDrawerEvents\n) {\n\n    /* @var {object} routes Message drawer route elements and callbacks. */\n    var routes = {};\n\n    /* @var {array} history Store for route objects history. */\n    var history = [];\n\n    var SELECTORS = {\n        CAN_RECEIVE_FOCUS: 'input:not([type=\"hidden\"]), a[href], button, textarea, select, [tabindex]',\n        ROUTES_BACK: '[data-route-back]'\n    };\n\n    /**\n     * Add a route.\n     *\n     * @param {string} route Route config name.\n     * @param {array} elements Route container objects.\n     * @param {callback} onGo Route initialization function.\n     * @param {callback} getDescription Route initialization function.\n     */\n    var add = function(route, elements, onGo, getDescription) {\n        routes[route] = {\n            elements: elements,\n            onGo: onGo,\n            getDescription: getDescription\n        };\n    };\n\n    /**\n     * Go to a defined route and run the route callbacks.\n     *\n     * @param {string} newRoute Route config name.\n     * @return {object} record Current route record with route config name and parameters.\n     */\n    var changeRoute = function(newRoute) {\n        var newConfig;\n        // Get the rest of the arguments, if any.\n        var args = [].slice.call(arguments, 1);\n        var renderPromise = $.Deferred().resolve().promise();\n\n        Object.keys(routes).forEach(function(route) {\n            var config = routes[route];\n            var isMatch = route === newRoute;\n\n            if (isMatch) {\n                newConfig = config;\n            }\n\n            config.elements.forEach(function(element) {\n                element.removeClass('previous');\n\n                if (isMatch) {\n                    element.removeClass('hidden');\n                    element.attr('aria-hidden', false);\n                } else {\n                    element.addClass('hidden');\n                    element.attr('aria-hidden', true);\n                }\n            });\n        });\n\n        if (newConfig) {\n            if (newConfig.onGo) {\n                renderPromise = newConfig.onGo.apply(undefined, newConfig.elements.concat(args));\n                var currentFocusElement = $(document.activeElement);\n                var hasFocus = false;\n\n                for (var i = 0; i < newConfig.elements.length; i++) {\n                    var element = newConfig.elements[i];\n\n                    if (element.has(currentFocusElement).length) {\n                        hasFocus = true;\n                        break;\n                    }\n                }\n\n                if (!hasFocus) {\n                    // This page doesn't have focus yet so focus the first focusable\n                    // element in the new view.\n                    newConfig.elements[0].find(SELECTORS.CAN_RECEIVE_FOCUS).filter(':visible').first().focus();\n                }\n            }\n        }\n\n        var record = {\n            route: newRoute,\n            params: args,\n            renderPromise: renderPromise\n        };\n\n        PubSub.publish(MessageDrawerEvents.ROUTE_CHANGED, record);\n\n        return record;\n    };\n\n    /**\n     * Go to a defined route and store the route history.\n     *\n     * @param {string} newRoute Route config name.\n     * @return {object} record Current route record with route config name and parameters.\n     */\n    var go = function() {\n        var currentFocusElement = $(document.activeElement);\n        var record = changeRoute.apply(null, arguments);\n        var inHistory = false;\n        // History stores a unique list of routes. Check to see if the new route\n        // is already in the history, if it is then forget all history after it.\n        // This ensures there are no duplicate routes in history and that it represents\n        // a linear path of routes (it never stores something like [foo, bar, foo])/\n        history = history.reduce(function(carry, previous) {\n            if (previous.route === record.route) {\n                inHistory = true;\n            }\n\n            if (!inHistory) {\n                carry.push(previous);\n            }\n\n            return carry;\n        }, []);\n\n        var previousRecord = history.length ? history[history.length - 1] : null;\n\n        if (previousRecord) {\n            var prevConfig = routes[previousRecord.route];\n            prevConfig.elements.forEach(function(element) {\n                element.addClass('previous');\n            });\n\n            previousRecord.focusElement = currentFocusElement;\n\n            if (prevConfig.getDescription) {\n                // If the route has a description then set it on the back button for\n                // the new page we're displaying.\n                prevConfig.getDescription.apply(null, prevConfig.elements.concat(previousRecord.params))\n                    .then(function(description) {\n                        return Str.get_string('backto', 'core_message', description);\n                    })\n                    .then(function(label) {\n                        // Wait for the new page to finish rendering so that we know\n                        // that the back button is visible.\n                        return record.renderPromise.then(function() {\n                            // Find the elements for the new route we displayed.\n                            routes[record.route].elements.forEach(function(element) {\n                                // Update the aria label for the back button.\n                                element.find(SELECTORS.ROUTES_BACK).attr('aria-label', label);\n                            });\n\n                            return;\n                        });\n                    })\n                    .catch(function() {\n                        // Silently ignore.\n                    });\n            }\n        }\n\n        history.push(record);\n        return record;\n    };\n\n    /**\n     * Go back to the previous route record stored in history.\n     */\n    var back = function() {\n        if (history.length) {\n            // Remove the current route.\n            history.pop();\n            var previous = history.pop();\n\n            if (previous) {\n                // If we have a previous route then show it.\n                go.apply(undefined, [previous.route].concat(previous.params));\n                // Delay the focus 50 milliseconds otherwise it doesn't correctly\n                // focus the element for some reason...\n                window.setTimeout(function() {\n                    previous.focusElement.focus();\n                }, 50);\n            }\n        }\n    };\n\n    return {\n        add: add,\n        go: go,\n        back: back\n    };\n});\n"],"file":"message_drawer_router.min.js"}