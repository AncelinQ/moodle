YUI.add("moodle-repository-filepicker",function(e,t){var n=function(){n.superclass.constructor.apply(this,arguments)};n.NAME="FilePickerHelper",n.ATTRS={options:{},lang:{}},e.extend(n,e.Base,{api:M.cfg.wwwroot+"/repository/repository_ajax.php",cached_responses:{},waitinterval:null,initializer:function(e){this.options=e,this.options.savepath||(this.options.savepath="/")},destructor:function(){},request:function(t,n){var r=(t.api?t.api:this.api)+"?action="+t.action,i={},s=t.scope?t.scope:this;i.repo_id=t.repository_id,i.p=t.path?t.path:"",i.page=t.page?t.page:"",i.env=this.options.env,i.accepted_types=this.options.accepted_types,i.sesskey=M.cfg.sesskey,i.client_id=t.client_id,i.itemid=this.options.itemid?this.options.itemid:0,i.maxbytes=this.options.maxbytes?this.options.maxbytes:-1,i.areamaxbytes=this.options.areamaxbytes?this.options.areamaxbytes:-1,this.options.context&&this.options.context.id&&(i.ctx_id=this.options.context.id);if(t.params)for(f in t.params)i[f]=t.params[f];if(t.action=="upload"){var o=[];for(var u in i){var a=i[u];if(a instanceof Array)for(var f in a)o.push(u+"[]="+a[f]);else o.push(u+"="+a)}i=o.join("&")}else i=build_querystring(i);var l={method:"POST",on:{complete:function(n,r,o){var u=null;try{u=e.JSON.parse(r.responseText)}catch(a){if(r&&r.status&&r.status>0){e.use("moodle-core-notification-exception",function(){return new M.core.exception(a)});return}}if(u&&u.error){e.use("moodle-core-notification-ajaxexception",function(){return new M.core.ajaxException(u)}),this.fpnode.one(".fp-content").setContent("");return}u.msg&&s.print_msg(u.msg,"info"),t.action!="upload"&&u.allowcaching&&(s.cached_responses[i]=u),t.callback(n,u,o)}},arguments:{scope:s},headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:i,context:this};t.form&&(l.form=t.form),!t.form&&t.action!="upload"&&s.cached_responses[i]?t.callback(null,s.cached_responses[i],{scope:s}):(e.io(r,l),n&&this.wait())},process_existing_file:function(t){var n=this,r=function(e){e.preventDefault();var t=this.process_dlg.dialogdata,r={};r.existingfilename=t.existingfile.filename,r.existingfilepath=t.existingfile.filepath,r.newfilename=t.newfile.filename,r.newfilepath=t.newfile.filepath,this.hide_header(),this.request({params:r,scope:this,action:"overwrite",path:"",client_id:this.options.client_id,repository_id:this.active_repo.id,callback:function(e,r,i){n.hide(),n.options.editor_target&&n.options.env=="editor"&&(n.options.editor_target.value=t.existingfile.url,n.options.editor_target.onchange());var s={client_id:n.options.client_id,url:t.existingfile.url,file:t.existingfile.filename},o=n.options.magicscope?n.options.magicscope:n;n.options.formcallback.apply(o,[s])}},!0)},i=function(e){e.preventDefault();var t=this,n=this.process_dlg.dialogdata;t.options.editor_target&&t.options.env=="editor"&&(t.options.editor_target.value=n.newfile.url,t.options.editor_target.onchange()),t.hide();var r=t.options.magicscope?t.options.magicscope:t,i={client_id:t.options.client_id,url:n.newfile.url,file:n.newfile.filename};t.options.formcallback.apply(r,[i])},s=function(e){e.preventDefault();var t={};t.newfilename=this.process_dlg.dialogdata.newfile.filename,t.newfilepath=this.process_dlg.dialogdata.newfile.filepath,this.request({params:t,scope:this,action:"deletetmpfile",path:"",client_id:this.options.client_id,repository_id:this.active_repo.id,callback:function(e,t,n){}},!1),this.process_dlg.hide(),this.selectui.hide()};if(!this.process_dlg){this.process_dlg_node=e.Node.createWithFilesSkin(M.core_filepicker.templates.processexistingfile);var o=this.process_dlg_node;o.generateID(),this.process_dlg=new M.core.dialogue({draggable:!0,bodyContent:o,headerContent:M.str.repository.fileexistsdialogheader,centered:!0,modal:!0,visible:!1,zIndex:this.options.zIndex}),o.one(".fp-dlg-butoverwrite").on("click",r,this),o.one(".fp-dlg-butrename").on("click",i,this),o.one(".fp-dlg-butcancel").on("click",s,this),this.options.env=="editor"?o.one(".fp-dlg-text").setContent(M.str.repository.fileexistsdialog_editor):o.one(".fp-dlg-text").setContent(M.str.repository.fileexistsdialog_filemanager)}this.selectnode.removeClass("loading"),this.process_dlg.dialogdata=t,this.process_dlg_node.one(".fp-dlg-butrename").setContent(M.util.get_string("renameto","repository",t.newfile.filename)),this.process_dlg.show()},display_error:function(t,n){this.fpnode.one(".fp-content").setContent(M.core_filepicker.templates.error),this.fpnode.one(".fp-content .fp-error").addClass(n).setContent(e.Escape.html(t))},print_msg:function(t,n){var r=M.str.moodle.error;n!="error"&&(n="info",r=M.str.moodle.info),this.msg_dlg||(this.msg_dlg_node=e.Node.createWithFilesSkin(M.core_filepicker.templates.message),this.msg_dlg_node.generateID(),this.msg_dlg=new M.core.dialogue({draggable:!0,bodyContent:this.msg_dlg_node,centered:!0,modal:!0,visible:!1,zIndex:this.options.zIndex}),this.msg_dlg_node.one(".fp-msg-butok").on("click",function(e){e.preventDefault(),this.msg_dlg.hide()},this)),this.msg_dlg.set("headerContent",r),this.msg_dlg_node.removeClass("fp-msg-info").removeClass("fp-msg-error").addClass("fp-msg-"+n),this.msg_dlg_node.one(".fp-msg-text").setContent(e.Escape.html(t)),this.msg_dlg.show()},view_files:function(e){this.viewbar_set_enabled(!0),this.print_path(),this.viewmode==2?this.view_as_list(e):this.viewmode==3?this.view_as_table(e):this.view_as_icons(e),this.fpnode.one(".fp-content").setAttribute("tabindex","0"),this.fpnode.one(".fp-content").focus(),!e&&this.active_repo.hasmorepages&&(this.fpnode.one(".fp-content .fp-nextpage")||this.fpnode.one(".fp-content").append(M.core_filepicker.templates.nextpage),this.fpnode.one(".fp-content .fp-nextpage").one("a,button").on("click",function(e){e.preventDefault(),this.fpnode.one(".fp-content .fp-nextpage").addClass("loading"),this.request_next_page()},this)),!this.active_repo.hasmorepages&&this.fpnode.one(".fp-content .fp-nextpage")&&this.fpnode.one(".fp-content .fp-nextpage").remove(),this.fpnode.one(".fp-content .fp-nextpage"
)&&this.fpnode.one(".fp-content .fp-nextpage").removeClass("loading"),this.content_scrolled()},content_scrolled:function(t){setTimeout(e.bind(function(){if(this.processingimages)return;this.processingimages=!0;var e=this,t=this.fpnode.one(".fp-content"),n=t.getY(),r=t.getStylePx("height"),i=t.one(".fp-nextpage"),s=function(e){var t=e.getY()-n;return t<=r&&(t>=0||t+e.getStylePx("height")>=0)?!0:!1};i&&!i.hasClass("loading")&&s(i)&&i.one("a,button").simulate("click"),e.lazyloading&&t.all("img").each(function(t){t.get("id")&&e.lazyloading[t.get("id")]&&s(t)&&t.setImgRealSrc(e.lazyloading)}),this.processingimages=!1},this),200)},treeview_dynload:function(e,t){var n={};if(e.children)for(var r in e.children)n[e.children[r].path]=e.children[r];this.request({action:"list",client_id:this.options.client_id,repository_id:this.active_repo.id,path:e.path?e.path:"",page:e.page?args.page:"",scope:this,callback:function(r,i,s){var o=i.list,u=s.scope;if(u.active_repo.id!=i.repo_id||u.viewmode!=2||!e||!e.getChildrenEl())return;t!=null&&(u.viewbar_set_enabled(!0),u.parse_repository_options(i)),e.highlight(!1),e.origlist=i.list?i.list:null,e.origpath=i.path?i.path:null,e.children=[];for(k in o)o[k].children&&n[o[k].path]?e.children[e.children.length]=n[o[k].path]:u.view_as_list([o[k]]);t==null?e.refresh():t(),u.content_scrolled()}},!1)},classnamecallback:function(t){var n="";return t.children&&(n+=" fp-folder"),t.isref&&(n+=" fp-isreference"),t.refcount&&(n+=" fp-hasreferences"),t.originalmissing&&(n+=" fp-originalmissing"),e.Lang.trim(n)},view_as_list:function(t){var n=t!=null?t:this.filelist;this.viewmode=2;if(!this.filelist||this.filelist.length==0&&(!this.filepath||!this.filepath.length)){this.display_error(M.str.repository.nofilesavailable,"nofilesavailable");return}var r=e.Node.create(M.core_filepicker.templates.listfilename),i={viewmode:this.viewmode,appendonly:t!=null,filenode:r,callbackcontext:this,callback:function(e,t){t.children?(this.filepath=e.node.origpath,this.filelist=e.node.origlist,this.currentpath=e.node.path,this.print_path(),this.content_scrolled()):(e.node.parent&&e.node.parent.origpath&&(this.filepath=e.node.parent.origpath,this.filelist=e.node.parent.origlist,this.print_path()),this.select_file(t))},classnamecallback:this.classnamecallback,dynload:this.active_repo.dynload,filepath:this.filepath,treeview_dynload:this.treeview_dynload};this.fpnode.one(".fp-content").fp_display_filelist(i,n,this.lazyloading)},view_as_icons:function(t){this.viewmode=1;var n=t!=null?t:this.filelist,r=e.Node.create(M.core_filepicker.templates.iconfilename);if(t==null&&(!this.filelist||!this.filelist.length)){this.display_error(M.str.repository.nofilesavailable,"nofilesavailable");return}var i={viewmode:this.viewmode,appendonly:t!=null,filenode:r,callbackcontext:this,callback:function(e,t){e.preventDefault&&e.preventDefault(),t.children?this.active_repo.dynload?this.list({path:t.path}):(this.filelist=t.children,this.view_files()):this.select_file(t)},classnamecallback:this.classnamecallback};this.fpnode.one(".fp-content").fp_display_filelist(i,n,this.lazyloading)},view_as_table:function(t){this.viewmode=3;var n=t!=null?t:this.filelist;if(!t&&(!this.filelist||this.filelist.length==0)&&!this.active_repo.hasmorepages){this.display_error(M.str.repository.nofilesavailable,"nofilesavailable");return}var r=e.Node.create(M.core_filepicker.templates.listfilename),i={viewmode:this.viewmode,appendonly:t!=null,filenode:r,callbackcontext:this,sortable:!this.active_repo.hasmorepages,callback:function(e,t){e.preventDefault&&e.preventDefault(),t.children?this.active_repo.dynload?this.list({path:t.path}):(this.filelist=t.children,this.view_files()):this.select_file(t)},classnamecallback:this.classnamecallback};this.fpnode.one(".fp-content").fp_display_filelist(i,n,this.lazyloading)},request_next_page:function(){if(!this.active_repo.hasmorepages||this.active_repo.nextpagerequested)return;this.active_repo.nextpagerequested=!0;var e=this.active_repo.page+1,t={page:e,repo_id:this.active_repo.id},n=this.active_repo.issearchresult?"search":"list";this.request({path:this.currentpath,scope:this,action:n,client_id:this.options.client_id,repository_id:t.repo_id,params:t,callback:function(e,t,n){var r=n.scope,i=!0;if(t.path&&r.filepath){var s=r.filepath[r.filepath.length-1],o=t.path[t.path.length-1];s.path!=o.path&&(i=!1)}r.active_repo.hasmorepages&&t.list&&t.page&&t.repo_id==r.active_repo.id&&t.page==r.active_repo.page+1&&i&&(r.parse_repository_options(t,!0),r.view_files(t.list))}},!1)},select_file:function(t){var n=t.title,r=30;n.length>r&&(n=n.substring(0,r)+"..."),e.one("#fp-file_label_"+this.options.client_id).setContent(e.Escape.html(M.str.repository.select+" "+n)),this.selectui.show(),e.one("#"+this.selectnode.get("id")).focus();var i=this.options.client_id,s=this.selectnode,o=this.options.repositories[this.active_repo.id].return_types;s.removeClass("loading"),s.one(".fp-saveas input").set("value",t.title);var u=e.Node.create("<img/>").set("src",t.realthumbnail?t.realthumbnail:t.thumbnail).setStyle("maxHeight",""+(t.thumbnail_height?t.thumbnail_height:90)+"px").setStyle("maxWidth",""+(t.thumbnail_width?t.thumbnail_width:90)+"px");s.one(".fp-thumbnail").setContent("").appendChild(u);var a=[2,1,4],f={},l=null,c=0;for(var h in a){var p=o&a[h]&&this.options.return_types&a[h];a[h]==1&&!this.options.externallink&&this.options.env=="editor"&&(p=!1),f[a[h]]=p,l=l==null&&p?a[h]:l,c+=p?1:0}for(var d in f){var v=s.one(".fp-linktype-"+d);v.addClassIf("uneditable",!(f[d]&&c>1)),v.one("input").set("disabled",f[d]&&c>1?"":"disabled").set("checked",l==d?"checked":"").simulate("change")}s.one(".fp-setauthor input").set("value",t.author?t.author:this.options.author),this.set_selected_license(s.one(".fp-setlicense"),t.license),s.one("form #filesource-"+i).set("value",t.source);var m=["datemodified","datecreated","size","license","author","dimensions"];for(var h in m)if(s.one(".fp-"+m[h])){var g=t[m[h]+"_f"]?t[m[h]+"_f"]:t[m[h]]?t[m[h]]:"";s.one(".fp-"+
m[h]).addClassIf("fp-unknown",""+g=="").one(".fp-value").setContent(e.Escape.html(g))}},setup_select_file:function(){var t=this.options.client_id,n=this.selectnode,r=n.one(".fp-select-confirm");n.all(".fp-saveas,.fp-linktype-2,.fp-linktype-1,.fp-linktype-4,.fp-setauthor,.fp-setlicense").each(function(e){e.all("label").set("for",e.one("input,select").generateID())}),n.one(".fp-linktype-2 input").setAttrs({value:2,name:"linktype"}),n.one(".fp-linktype-1 input").setAttrs({value:1,name:"linktype"}),n.one(".fp-linktype-4 input").setAttrs({value:4,name:"linktype"});var i=function(e){if(e.currentTarget.get("checked")){var t=e.currentTarget.get("value")!=1;n.all(".fp-setauthor,.fp-setlicense,.fp-saveas").each(function(e){e.addClassIf("uneditable",!t),e.all("input,select").set("disabled",t?"":"disabled")})}};n.all(".fp-linktype-2,.fp-linktype-1,.fp-linktype-4").each(function(e){e.one("input").on("change",i,this)}),this.populate_licenses_select(n.one(".fp-setlicense select")),r.on("click",function(e){e.preventDefault();var t=this.options.client_id,r=this,i=this.active_repo.id,s=n.one(".fp-saveas input").get("value"),o=n.one("form #filesource-"+t).get("value"),u={title:s,source:o,savepath:this.options.savepath},a=n.one(".fp-setlicense select");if(a){u.license=a.get("value");var f=n.one(".fp-license .fp-value");f&&(f=f.getContent()),this.set_preference("recentlicense",a.get("value"))}u.author=n.one(".fp-setauthor input").get("value");var l=this.options.repositories[this.active_repo.id].return_types;this.options.env=="editor"&&(u.savepath="/"),(this.options.externallink||this.options.env!="editor")&&l&1&&this.options.return_types&1&&n.one(".fp-linktype-1 input").get("checked")?u.linkexternal="yes":l&4&&this.options.return_types&4&&n.one(".fp-linktype-4 input").get("checked")&&(u.usefilereference="1"),n.addClass("loading"),this.request({action:"download",client_id:t,repository_id:i,params:u,onerror:function(e,t,i){n.removeClass("loading"),r.selectui.hide()},callback:function(e,i,s){n.removeClass("loading");if(i.event=="fileexists"){r.process_existing_file(i);return}r.options.editor_target&&r.options.env=="editor"&&(r.options.editor_target.value=i.url,r.options.editor_target.onchange()),r.hide(),i.client_id=t;var o=s.scope.options.magicscope?s.scope.options.magicscope:s.scope;r.options.formcallback.apply(o,[i])}},!1)},this);var s=n.one("form");s.appendChild(e.Node.create("<input/>").setAttrs({type:"hidden",id:"filesource-"+t})),s.on("keydown",function(e){e.keyCode==13&&(r.simulate("click"),e.preventDefault())},this);var o=n.one(".fp-select-cancel");o.on("click",function(e){e.preventDefault(),this.selectui.hide()},this)},wait:function(){this.waitinterval!=null&&clearInterval(this.waitinterval);var t=this.fpnode.one(".fp-content"),n=e.Node.create(M.core_filepicker.templates.loading).addClass("fp-content-hidden").setStyle("opacity",0),r=0,i=setInterval(function(){if(!n||!t.contains(n)||r>=15)return clearInterval(i),!0;if(r==5)n.removeClass("fp-content-hidden");else if(r>5){var e=parseFloat(n.getStyle("opacity"));n.setStyle("opacity",e+.1)}return r++,!1},100);this.waitinterval=i,t.setContent(n)},viewbar_set_enabled:function(e){var t=this.fpnode.one(".fp-viewbar");t&&(e?t.addClass("enabled").removeClass("disabled"):t.removeClass("enabled").addClass("disabled")),this.fpnode.all(".fp-vb-icons,.fp-vb-tree,.fp-vb-details").removeClass("checked");var n={1:"icons",2:"tree",3:"details"};this.fpnode.all(".fp-vb-"+n[this.viewmode]).addClass("checked")},viewbar_clicked:function(e){e.preventDefault();var t=this.fpnode.one(".fp-viewbar");if(!t||!t.hasClass("disabled"))e.currentTarget.hasClass("fp-vb-tree")?this.viewmode=2:e.currentTarget.hasClass("fp-vb-details")?this.viewmode=3:this.viewmode=1,this.viewbar_set_enabled(!0),this.view_files(),this.set_preference("recentviewmode",this.viewmode)},render:function(){var t=this.options.client_id,n="filepicker-"+t,r="fp-dialog-label_"+t;this.fpnode=e.Node.createWithFilesSkin(M.core_filepicker.templates.generallayout).set("id","filepicker-"+t).set("aria-labelledby",r),this.mainui=new M.core.dialogue({extraClasses:["filepicker"],draggable:!0,bodyContent:this.fpnode,headerContent:'<span id="'+r+'">'+M.str.repository.filepicker+"</span>",centered:!0,modal:!0,visible:!1,width:"873px",responsiveWidth:873,height:"558px",zIndex:this.options.zIndex}),this.selectnode=e.Node.createWithFilesSkin(M.core_filepicker.templates.selectlayout).set("id","filepicker-select-"+t).set("aria-live","assertive").set("role","dialog");var i="fp-file_label_"+t;this.selectui=new M.core.dialogue({headerContent:'<span id="'+i+'">'+M.str.repository.select+"</span>",draggable:!0,width:"450px",bodyContent:this.selectnode,centered:!0,modal:!0,visible:!1,zIndex:this.options.zIndex}),e.one("#"+this.selectnode.get("id")).setAttribute("aria-labelledby",i),this.fpnode.one(".fp-content").on(["scroll","resize"],this.content_scrolled,this),this.fpnode.one(".fp-path-folder")&&(this.pathnode=this.fpnode.one(".fp-path-folder"),this.pathbar=this.pathnode.get("parentNode"),this.pathbar.removeChild(this.pathnode)),this.fpnode.one(".fp-vb-icons").on("click",this.viewbar_clicked,this),this.fpnode.one(".fp-vb-tree").on("click",this.viewbar_clicked,this),this.fpnode.one(".fp-vb-details").on("click",this.viewbar_clicked,this),this.setup_toolbar(),this.setup_select_file(),this.hide_header();var s=[];for(var o in this.options.repositories)s[o]=this.options.repositories[o];s.sort(function(e,t){return e.sortorder-t.sortorder});var u=this.fpnode.one(".fp-repo");if(u){var a=u.get("parentNode");a.removeChild(u);for(o in s){var f=s[o],l=u.cloneNode(!0);a.appendChild(l),l.set("id","fp-repo-"+t+"-"+f.id).on("click",function(e,t){e.preventDefault(),this.set_preference("recentrepository",t),this.hide_header(),this.list({repo_id:t})},this,f.id),l.one(".fp-repo-name").setContent(e.Escape.html(f.name)),l.one(".fp-repo-icon").set("src",f.icon),o==0&&l.addClass("first"),o==s.length-1&&l.addClass("last"),o%2?l.addClass("even"):l.addClass("odd")}}s.length==0&&
this.display_error(M.str.repository.norepositoriesavailable,"norepositoriesavailable"),this.mainui.show(),this.show_recent_repository()},parse_repository_options:function(e,t){if(t){if(e.list){this.filelist||(this.filelist=[]);for(var n in e.list)this.filelist[this.filelist.length]=e.list[n]}}else this.filelist=e.list?e.list:null,this.lazyloading={};this.filepath=e.path?e.path:null,this.objecttag=e.object?e.object:null,this.active_repo={},this.active_repo.issearchresult=e.issearchresult?!0:!1,this.active_repo.dynload=e.dynload?e.dynload:!1,this.active_repo.pages=Number(e.pages?e.pages:null),this.active_repo.page=Number(e.page?e.page:null),this.active_repo.hasmorepages=this.active_repo.pages&&this.active_repo.page&&(this.active_repo.page<this.active_repo.pages||this.active_repo.pages==-1),this.active_repo.id=e.repo_id?e.repo_id:null,this.active_repo.nosearch=e.login||e.nosearch,this.active_repo.norefresh=e.login||e.norefresh,this.active_repo.nologin=e.login||e.nologin,this.active_repo.logouttext=e.logouttext?e.logouttext:null,this.active_repo.logouturl=e.logouturl||"",this.active_repo.message=e.message||"",this.active_repo.help=e.help?e.help:null,this.active_repo.manage=e.manage?e.manage:null,this.print_header()},print_login:function(t){this.parse_repository_options(t);var n=this.options.client_id,r=t.repo_id,i=this.logindata=t.login,s="",o=t.login_btn_action?t.login_btn_action:"login",u="fp-form-"+n,a=e.Node.create(M.core_filepicker.templates.loginform);a.one("form").set("id",u),this.fpnode.one(".fp-content").setContent("").appendChild(a);var f={popup:a.one(".fp-login-popup"),textarea:a.one(".fp-login-textarea"),select:a.one(".fp-login-select"),text:a.one(".fp-login-text"),radio:a.one(".fp-login-radiogroup"),checkbox:a.one(".fp-login-checkbox"),input:a.one(".fp-login-input")},l;for(var c in f)f[c]&&(l=f[c].get("parentNode"),l.removeChild(f[c]));for(var h in i){if(f[i[h].type])var p=f[i[h].type].cloneNode(!0);else p=f.input.cloneNode(!0);if(i[h].type=="popup"){s=i[h].url;var d=p.one("button");d.on("click",function(e){M.core_filepicker.active_filepicker=this,window.open(s,"repo_auth","location=0,status=0,width=500,height=300,scrollbars=yes"),e.preventDefault()},this),a.one("form").on("keydown",function(e){e.keyCode==13&&(d.simulate("click"),e.preventDefault())},this),a.all(".fp-login-submit").remove(),o="popup"}else if(i[h].type=="textarea")p.one("label")&&p.one("label").set("for",i[h].id).setContent(i[h].label),p.one("textarea").setAttrs({id:i[h].id,name:i[h].name});else if(i[h].type=="select"){p.one("label")&&p.one("label").set("for",i[h].id).setContent(i[h].label),p.one("select").setAttrs({id:i[h].id,name:i[h].name}).setContent("");for(c in i[h].options)p.one("select").appendChild(e.Node.create("<option/>").set("value",i[h].options[c].value).setContent(i[h].options[c].label))}else if(i[h].type=="radio"){p.all("label").setContent(i[h].label);var v=i[h].value.split("|"),m=i[h].value_label.split("|"),g=null;for(var y in v){if(g==null)g=p.one(".fp-login-radio"),g.one("input").set("checked","checked");else{var b=g.cloneNode(!0);g.insert(b,"after"),g=b,g.one("input").set("checked","")}g.one("input").setAttrs({id:""+i[h].id+y,name:i[h].name,type:i[h].type,value:v[y]}),g.all("label").setContent(m[y]).set("for",""+i[h].id+y)}g==null&&p.one(".fp-login-radio").remove()}else p.one("label")&&p.one("label").set("for",i[h].id).setContent(i[h].label),p.one("input").set("type",i[h].type).set("id",i[h].id).set("name",i[h].name).set("value",i[h].value?i[h].value:"");l.appendChild(p)}t.login_btn_label&&a.all(".fp-login-submit").setContent(t.login_btn_label),(o=="login"||o=="search")&&a.one(".fp-login-submit").on("click",function(e){e.preventDefault(),this.hide_header(),this.request({scope:this,action:o=="search"?"search":"signin",path:"",client_id:n,repository_id:r,form:{id:u,upload:!1,useDisabled:!0},callback:this.display_response},!0)},this),a.one(".fp-login-submit")&&a.one("form").on("keydown",function(e){e.keyCode==13&&(a.one(".fp-login-submit").simulate("click"),e.preventDefault())},this)},display_response:function(t,n,r){var i=r.scope;i.fpnode.all(".fp-repo.active").removeClass("active"),i.fpnode.all("#fp-repo-"+i.options.client_id+"-"+n.repo_id).addClass("active");for(var s in i.options.repositories)i.fpnode.removeClass("repository_"+i.options.repositories[s].type);n.repo_id&&i.options.repositories[n.repo_id]&&i.fpnode.addClass("repository_"+i.options.repositories[n.repo_id].type),e.one(".file-picker .fp-repo-items").focus(),n.login?(i.viewbar_set_enabled(!1),i.print_login(n)):n.upload?(i.viewbar_set_enabled(!1),i.parse_repository_options(n),i.create_upload_form(n)):n.object?(M.core_filepicker.active_filepicker=i,i.viewbar_set_enabled(!1),i.parse_repository_options(n),i.create_object_container(n.object)):n.list&&(i.viewbar_set_enabled(!0),i.parse_repository_options(n),i.view_files())},list:function(e){e||(e={}),e.repo_id||(e.repo_id=this.active_repo.id),e.path||(e.path=""),this.currentpath=e.path,this.request({action:"list",client_id:this.options.client_id,repository_id:e.repo_id,path:e.path,page:e.page,scope:this,callback:this.display_response},!0)},populate_licenses_select:function(t){if(!t)return;t.setContent("");var n=this.options.licenses,r=this.get_preference("recentlicense");r&&(this.options.defaultlicense=r);for(var i in n){var s=e.Node.create("<option/>").set("selected",this.options.defaultlicense==n[i].shortname).set("value",n[i].shortname).setContent(e.Escape.html(n[i].fullname));t.appendChild(s)}},set_selected_license:function(e,t){var n=!1;e.all("option").each(function(e){if(e.get("value")==t||e.getContent()==t)e.set("selected",!0),n=!0});if(!n){var r=this.get_preference("recentlicense");e.all("option[selected]").set("selected",!1),e.all("option[value="+r+"]").set("selected",!0)}},create_object_container:function(t){var n=this.fpnode.one(".fp-content");n.setContent("");var r=e.Node.create("<object/>").setAttrs({data:t.src,type:t.type,id:"container_object"}).addClass("fp-object-container"
);n.setContent("").appendChild(r)},create_upload_form:function(t){var n=this.options.client_id,r=t.upload.id+"_"+n,i=this.fpnode.one(".fp-content"),s="uploadform_"+this.options.repositories[t.repo_id].type,o=M.core_filepicker.templates[s]||M.core_filepicker.templates.uploadform;i.setContent(o),i.all(".fp-file,.fp-saveas,.fp-setauthor,.fp-setlicense").each(function(e){e.all("label").set("for",e.one("input,select").generateID())}),i.one("form").set("id",r),i.one(".fp-file input").set("name","repo_upload_file"),t.upload.label&&i.one(".fp-file label")&&i.one(".fp-file label").setContent(t.upload.label),i.one(".fp-saveas input").set("name","title"),i.one(".fp-setauthor input").setAttrs({name:"author",value:this.options.author}),i.one(".fp-setlicense select").set("name","license"),this.populate_licenses_select(i.one(".fp-setlicense select")),i.one("form").appendChild(e.Node.create("<input/>").setAttrs({type:"hidden",name:"itemid",value:this.options.itemid}));var u=this.options.accepted_types;for(var a in u)i.one("form").appendChild(e.Node.create("<input/>").setAttrs({type:"hidden",name:"accepted_types[]",value:u[a]}));var f=this;i.one(".fp-upload-btn").on("click",function(e){e.preventDefault();var s=i.one(".fp-setlicense select");this.set_preference("recentlicense",s.get("value"));if(!i.one(".fp-file input").get("value"))return f.print_msg(M.str.repository.nofilesattached,"error"),!1;this.hide_header(),f.request({scope:f,action:"upload",client_id:n,params:{savepath:f.options.savepath},repository_id:f.active_repo.id,form:{id:r,upload:!0},onerror:function(e,n,r){f.create_upload_form(t)},callback:function(e,r,i){if(r.event=="fileexists"){f.create_upload_form(t),f.process_existing_file(r);return}f.options.editor_target&&f.options.env=="editor"&&(f.options.editor_target.value=r.url,f.options.editor_target.onchange()),f.hide(),r.client_id=n;var s=i.scope.options.magicscope?i.scope.options.magicscope:i.scope;f.options.formcallback.apply(s,[r])}},!0)},this)},setup_toolbar:function(){var t=this.options.client_id,n=this.fpnode.one(".fp-toolbar");n.one(".fp-tb-logout").one("a,button").on("click",function(e){e.preventDefault(),this.active_repo.nologin||(this.hide_header(),this.request({action:"logout",client_id:this.options.client_id,repository_id:this.active_repo.id,path:"",callback:this.display_response},!0)),this.active_repo.logouturl&&window.open(this.active_repo.logouturl,"repo_auth","location=0,status=0,width=500,height=300,scrollbars=yes")},this),n.one(".fp-tb-refresh").one("a,button").on("click",function(e){e.preventDefault(),this.active_repo.norefresh||this.list({path:this.currentpath})},this),n.one(".fp-tb-search form").set("method","POST").set("id","fp-tb-search-"+t).on("submit",function(e){e.preventDefault(),this.active_repo.nosearch||this.request({scope:this,action:"search",client_id:this.options.client_id,repository_id:this.active_repo.id,form:{id:"fp-tb-search-"+t,upload:!1,useDisabled:!0},callback:this.display_response},!0)},this);var r=e.Node.create("<a/>").setAttrs({id:"fp-tb-manage-"+t+"-link",target:"_blank"}).setStyle("display","none");n.append(r),n.one(".fp-tb-manage").one("a,button").on("click",function(e){e.preventDefault(),r.simulate("click")});var i=e.Node.create("<a/>").setAttrs({id:"fp-tb-help-"+t+"-link",target:"_blank"}).setStyle("display","none");n.append(i),n.one(".fp-tb-help").one("a,button").on("click",function(e){e.preventDefault(),i.simulate("click")})},hide_header:function(){this.fpnode.one(".fp-toolbar")&&this.fpnode.one(".fp-toolbar").addClass("empty"),this.pathbar&&this.pathbar.setContent("").addClass("empty")},print_header:function(){var t=this.active_repo,n=this,r=this.options.client_id;this.hide_header(),this.print_path();var i=this.fpnode.one(".fp-toolbar");if(!i)return;var s=function(e,t){if(!e)return;e.addClassIf("disabled",!t).addClassIf("enabled",t),t&&i.removeClass("empty")};s(i.one(".fp-tb-back"),!1),s(i.one(".fp-tb-search"),!t.nosearch);if(!t.nosearch){var o=i.one(".fp-tb-search form");o.setContent(""),this.request({scope:this,action:"searchform",repository_id:this.active_repo.id,callback:function(e,t,r){if(t.repo_id==n.active_repo.id&&t.form){o.setContent(t.form);var i=o.one('input[name="s"]');i&&i.once("click",function(e){e.preventDefault(),this.select()})}}},!1)}s(i.one(".fp-tb-refresh"),!t.norefresh),s(i.one(".fp-tb-logout"),!t.nologin),s(i.one(".fp-tb-manage"),t.manage),e.one("#fp-tb-manage-"+r+"-link").set("href",t.manage),s(i.one(".fp-tb-help"),t.help),e.one("#fp-tb-help-"+r+"-link").set("href",t.help),s(i.one(".fp-tb-message"),t.message),i.one(".fp-tb-message").setContent(t.message)},print_path:function(){if(!this.pathbar)return;this.pathbar.setContent("").addClass("empty");var t=this.filepath;if(t&&t.length!=0&&this.viewmode!=2){for(var n=0;n<t.length;n++){var r=this.pathnode.cloneNode(!0);this.pathbar.appendChild(r),n==0&&r.addClass("first"),n==t.length-1&&r.addClass("last"),n%2?r.addClass("even"):r.addClass("odd"),r.all(".fp-path-folder-name").setContent(e.Escape.html(t[n].name)),r.on("click",function(e,t){e.preventDefault(),this.list({path:t})},this,t[n].path)}this.pathbar.removeClass("empty")}},hide:function(){this.selectui.hide(),this.process_dlg&&this.process_dlg.hide(),this.msg_dlg&&this.msg_dlg.hide(),this.mainui.hide()},show:function(){this.fpnode?(this.hide(),this.mainui.show(),this.show_recent_repository()):this.launch()},launch:function(){this.render()},show_recent_repository:function(){this.hide_header(),this.viewbar_set_enabled(!1);var e=this.get_preference("recentrepository");this.viewmode=this.get_preference("recentviewmode"),this.viewmode!=2&&this.viewmode!=3&&(this.viewmode=1),this.options.repositories[e]&&this.list({repo_id:e})},get_preference:function(e){return this.options.userprefs[e]?this.options.userprefs[e]:!1},set_preference:function(e,t){this.options.userprefs[e]!=t&&(M.util.set_user_preference("filepicker_"+e,t),this.options.userprefs[e]=t)}}),M.repository=M.repository||{},M.repository.FilePickerHelper=n},"@VERSION@",{requires
:["base","node","node-event-simulate","json","async-queue","io-base","io-upload-iframe","io-form","yui2-treeview","panel","cookie","datatable","datatable-sort","resize-plugin","dd-plugin","escape","moodle-core_filepicker"]});
