YUI.add("moodle-repository-filepicker-new",function(e,t){var n=function(){n.superclass.constructor.apply(this,arguments)};e.extend(n,M.core.dialogue,{compiledTemplates:{},activeRepository:null,activeRepositoryID:null,baseIOConfig:null,spinner:null,cachedResponses:null,treeview:null,loginHandlers:[],initializer:function(){},show:function(){if(this.checkInitialSetup())return n.superclass.show.call(this)},checkInitialSetup:function(){var t=this.get("boundingBox");if(!t.hasClass("filepicker")){var n=this.getTemplate("generallayout");this.setAttrs({bodyContent:n,footerContent:null,width:"auto"}),this.updateRepositoryList(),t.delegate("click",this.handleRepositorySelection,".fp-repo",this),this.get("boundingBox").addClass("filepicker"),this.spinner=e.Node.create('<div class="spinner">'),this.cachedResponses=new e.Cache,this.treeview=new e.M.repository.filepicker.FileTree}return this},handleRepositorySelection:function(e){e.preventDefault(),this.selectRepository(e.currentTarget.getData("repositoryid"))},selectRepository:function(e){var t=this.get("boundingBox"),n=t.one(".fp-list"),r=this.get("repositories"),i;this.activeRepositoryID&&r[this.activeRepositoryID]&&(i=r[this.activeRepositoryID],n.all(".active").removeClass("active"),t.removeClass("repository_"+i.type)),this.activeRepositoryID=e,r[this.activeRepositoryID]&&(this.activeRepository=r[this.activeRepositoryID],n.one('[data-repositoryid="'+e+'"]').addClass("active"),t.addClass("repository_"+this.activeRepository.type),this.performRequest("list"))},parseRepositoryResult:function(e){this.updateToolbar(e),e.login?this.displayLogin(e):e.upload?this.displayUploadForm(e):e.object?this.createObjectContainer(e):e.list&&this.updateFileList(this.treeview.rootNode,e.list,!0)},updateToolbar:function(t){var n=this.get("boundingBox").one(".fp-repo-items"),r=["refresh","login","manage","help","message","search"];t.toolbar&&(e.each(r,function(e){n.toggleClass("no"+e,!t.toolbar[e])}),n.toggleClass("noback",!0)),this.displayPath(t.p||[])},displayPath:function(e){var t=this.get("boundingBox").one(".fp-pathbar");if(e.length===0){t.hide();return}t.show()},displayLogin:function(t){var n={client_id:this.get("client_id")},r=e.Node.create(this.getTemplate("loginform",n)),i=r.one("table"),s={},o="login";t.login_btn_action&&(o=t.login_btn_action),e.each(t.login,function(e){var t=this.getTemplate("loginform_"+e.type,e);t||(t=this.getTemplate("loginform_input",e)),i.appendChild(t),s[e.type]=!0},this),e.each(s,function(e){e==="popup"&&(loginHandlers.push(r.delegate("click",function(e){window.open(e.currentTarget.getData("loginurl"),"repo_auth","location=0,status=0,width=500,height=300,scrollbars=yes"),e.preventDefault()},"button.fp-login-popup-but",this)),r.delegate("keydown",function(e){e.keyCode===13&&(popupbutton.simulate("click"),e.preventDefault())},"form",this),r.all(".fp-login-submit").remove())},this),(o==="login"||o==="search")&&r.one(".fp-login-submit").on("click",function(e){e.preventDefault();var t={data:{path:""},form:{id:this.get("client_id"),upload:!1,useDisabled:!0}};o!=="search"&&(o="signin"),this.performRequest(o,t)},this),this.updateContent(r)},displayUploadForm:function(){var t={client_id:this.get("client_id"),itemid:this.get("itemid"),types:this.get("accepted_types"),file:"repo_upload_file",saveas:"title",author:"author",license:"license",licenses:this.get("licenses"),selectedLicense:this.get("defaultlicense")},n;n=this.getTemplate("uploadform_"+this.activeRepository.type,t),n||(n=this.getTemplate("uploadform",t));var r=e.Node.create(n);this.updateContent(r)},createObjectContainer:function(e){var t=e;t=e},updateFileList:function(e,t,n){n&&e.empty(),e.append(t)},performRequest:function(t,n,r,i){var s="fakekey";if(t!=="upload")var o=this.cachedResponses.retrieve(s);this.baseIOConfig||(this.baseIOConfig={context:this,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:{sesskey:M.cfg.sesskey,itemid:this.get("itemid"),maxbytes:this.get("maxbytes"),areamaxbytes:this.get("areamaxbytes"),env:this.get("env"),ctx_id:this.get("context").id,accepted_types:this.get("accepted_types"),client_id:this.get("client_id"),p:"",page:""},on:{complete:this.completeRequest}}),n=n||{},n.data=n.data||{};var u=e.clone(this.baseIOConfig);u.data=e.merge(u.data,n.data,{repo_id:this.activeRepositoryID,action:t}),u.arguments={callback:r,cachekey:s,action:u.data.action},n.form&&(u.form=n.form),i&&(u.on.start=function(){this.spinner.show()}),e.io(this.get("api"),u)},completeRequest:function(t,n,r){var i;try{i=e.JSON.parse(n.responseText)}catch(s){if(n&&n.status&&n.status>0){e.use("moodle-core-notification-exception",function(){new M.core.exception(s)});return}}if(i&&i.error){e.use("moodle-core-notification-ajaxexception",function(){new M.core.ajaxException(i)});return}i.msg&&this.print_msg(i.msg,"info"),r.action!=="upload"&&r.cachekey&&i.allowcaching&&this.cachedResponses.add(r.cachekey,i),this.parseRepositoryResult(i,r),typeof r.callback=="function"&&r.callback.apply(this,[i,r])},updateRepositoryList:function(){var t=[],n=this.get("boundingBox").one(".fp-repo-area .fp-list");e.Object.each(this.get("repositories"),function(e){t[e.id]=e}),t.sort(function(e,t){return e.sortorder-t.sortorder}),n.empty(),e.Array.each(t,function(e){var t=this.getTemplate("repository",e);n.appendChild(t)},this)},updateContent:function(e){this.get("boundingBox").one(".fp-content").empty().appendChild(e)},getTemplate:function(t,n){return M.cfg.templates[t]?(this.compiledTemplates[t]||(this.compiledTemplates[t]=e.Handlebars.compile(M.cfg.templates[t])),n||(n={}),this.compiledTemplates[t](n)):""}},{NAME:"filepicker",ATTRS:{api:{value:M.cfg.wwwroot+"/repository/repository_ajax.php"},savepath:{value:"/"},repositories:{value:{}},client_id:{value:null},itemid:{value:0},maxbytes:{value:-1},areamaxbytes:{value:-1},context:{value:null},env:{value:{id:null}},accepted_types:{value:[]},licenses:{value:[]}}}),e.Base.modifyAttrs(n,{visible:{value:!1},rendered:{value:!1},modal:{value
:!0},draggable:{value:!0},centered:{value:!0}}),e.namespace("M.repository").FilePicker=n},"@VERSION@",{requires:["base","moodle-core-notification-dialogue","node","handlebars","cache","io","moodle-repository-filepicker-filetree"]});
