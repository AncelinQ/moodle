define("core/form-autocomplete",["jquery","core/log","core/str","core/templates","core/notification"],function(a,b,c,d,f){var g={DOWN:40,ENTER:13,SPACE:32,ESCAPE:27,COMMA:44,UP:38},e=a.now(),h=function(b,c){var d=a(document.getElementById(c.selectionId)),e=d.children("[aria-selected=true]").length;b=b%e;while(0>b){b+=e}var f=a(d.children("[aria-selected=true]").get(b)),g=c.selectionId+"-"+b;d.children().attr("data-active-selection",!1).attr("id","");f.attr("data-active-selection",!0).attr("id",g);d.attr("aria-activedescendant",g);return a.Deferred().resolve()},i=function(b,c,e){var g="form-autocomplete-updateSelectionList-"+c.inputId;M.util.js_pending(g);var i=[],j=a(document.getElementById(c.selectionId)),k=j.attr("aria-activedescendant"),l=!1;if(k){l=a(document.getElementById(k)).attr("data-value")}e.children("option").each(function(b,c){if(a(c).prop("selected")){var d;if(a(c).data("html")){d=a(c).data("html")}else{d=a(c).html()}i.push({label:d,value:a(c).attr("value")})}});var m=a.extend({items:i},b,c);return d.render("core/form_autocomplete_selection",m).then(function(b,e){d.replaceNodeContents(j,b,e);if(!1!==l){j.children("[aria-selected=true]").each(function(b,d){if(a(d).attr("data-value")===l){h(b,c)}})}return l}).then(function(){return M.util.js_complete(g)}).catch(f.exception)},j=function(a){if("undefined"!=typeof M.core_formchangechecker){M.core_formchangechecker.set_form_changed()}a.change()},k=function(b,c,d,e){var f=a(d).attr("data-value");if(b.multiple){e.children("option").each(function(b,c){if(a(c).attr("value")==f){a(c).prop("selected",!1);if(a(c).attr("data-iscustom")){a(c).remove()}}})}return i(b,c,e).then(function(){j(e)})},l=function(b,c){var d=a(document.getElementById(c.inputId)),e=a(document.getElementById(c.suggestionsId)),f=e.children("[aria-hidden=false]").length;b=b%f;while(0>b){b+=f}var g=a(e.children("[aria-hidden=false]").get(b)),h=a(e.children("[role=option]")).index(g),i=c.suggestionsId+"-"+h;e.children().attr("aria-selected",!1).attr("id","");g.attr("aria-selected",!0).attr("id",i);d.attr("aria-activedescendant",i);var j=g.offset().top-e.offset().top+e.scrollTop()-e.height()/2;return e.animate({scrollTop:j},100).promise()},m=function(b){var c=a(document.getElementById(b.suggestionsId)),d=c.children("[aria-selected=true]"),e=c.children("[aria-hidden=false]").index(d);return l(e+1,b)},n=function(b){var c=a(document.getElementById(b.selectionId)),d=c.children("[data-active-selection=true]");if(!d){return h(0,b)}var e=c.children("[aria-selected=true]").index(d);return h(e-1,b)},o=function(b){var c=a(document.getElementById(b.selectionId)),d=c.children("[data-active-selection=true]"),e=0;if(d){e=c.children("[aria-selected=true]").index(d);e=e+1}else{e=0}return h(e,b)},p=function(b){var c=a(document.getElementById(b.suggestionsId)),d=c.children("[aria-selected=true]"),e=c.children("[aria-hidden=false]").index(d);return l(e-1,b)},q=function(b){var c=a(document.getElementById(b.inputId)),d=a(document.getElementById(b.suggestionsId));c.attr("aria-expanded",!1).attr("aria-activedescendant",b.selectionId);d.hide().attr("aria-hidden",!0);return a.Deferred().resolve()},r=function(b,e,g,h){var i="form-autocomplete-updateSuggestions-"+e.inputId;M.util.js_pending(i);var j=a(document.getElementById(e.inputId)),k=a(document.getElementById(e.suggestionsId)),m=!1,n=[];h.children("option").each(function(b,c){if(!0!==a(c).prop("selected")){n[n.length]={label:c.innerHTML,value:a(c).attr("value")}}});var o=e.caseSensitive?g:g.toLocaleLowerCase(),p=a.extend({options:n},b,e),q=d.render("core/form_autocomplete_suggestions",p).then(function(f,g){d.replaceNode(k,f,g);k=a(document.getElementById(e.suggestionsId));k.show().attr("aria-hidden",!1);k.children().each(function(c,d){d=a(d);if(b.caseSensitive&&-1<d.text().indexOf(o)||!b.caseSensitive&&-1<d.text().toLocaleLowerCase().indexOf(o)){d.show().attr("aria-hidden",!1);m=!0}else{d.hide().attr("aria-hidden",!0)}});j.attr("aria-expanded",!0);if(h.attr("data-notice")){k.html(h.attr("data-notice"))}else if(m){if(!b.tags){l(0,e)}}else{c.get_string("nosuggestions","form").done(function(a){k.html(a)})}return k}).then(function(){return M.util.js_complete(i)}).catch(f.exception);return q},s=function(b,c,d){var e=a(document.getElementById(c.inputId)),f=e.val(),g=f.split(","),h=!1;a.each(g,function(c,e){e=e.trim();if(""!==e){if(!b.multiple){d.children("option").prop("selected",!1)}d.children("option").each(function(b,c){if(a(c).attr("value")==e){h=!0;a(c).prop("selected",!0)}});if(!h){var f=a("<option>");f.append(document.createTextNode(e));f.attr("value",e);d.append(f);f.prop("selected",!0);f.attr("data-iscustom",!0)}}});return i(b,c,d).then(function(){j(d)}).then(function(){e.val("")}).then(function(){return q(c)})},t=function(b,c,d){var e=a(document.getElementById(c.inputId)),f=a(document.getElementById(c.suggestionsId)),g=f.children("[aria-selected=true]").attr("data-value");if(!b.multiple){d.children("option").prop("selected",!1)}d.children("option").each(function(b,c){if(a(c).attr("value")==g){a(c).prop("selected",!0)}});return i(b,c,d).then(function(){j(d)}).then(function(){if(b.closeSuggestionsOnSelect){e.val("");return q(c)}else{e.focus();return r(b,c,e.val(),d)}})},u=function(b,c,d,e,f){var g=w("updateAjax"),h=a(b.currentTarget).val();f.transport(c.selector,h,function(b){var h=f.processResults(c.selector,b),i=[];e.children("option").each(function(b,c){c=a(c);if(!c.prop("selected")){c.remove()}else{i.push(c.attr("value")+"")}});if(!c.multiple&&0===e.children("option").length){var j=a("<option>");e.append(j)}if(a.isArray(h)){a.each(h,function(b,c){if(-1===i.indexOf(c.value+"")){var d=a("<option>");d.append(c.label);d.attr("value",c.value);e.append(d)}});e.attr("data-notice","")}else{e.attr("data-notice",h)}g.resolve(r(c,d,"",e))},function(a){g.reject(a)});return g},v=function(b,c,d){var h=a(document.getElementById(c.inputId));h.on("keydown",function(f){var e=w("addNavigation-"+c.inputId+"-"+f.keyCode);switch(f.keyCode){case g.DOWN:if(!b.showSuggestions){e.resolve();return!0}else if("true"===h.attr("aria-expanded")){e.resolve(m(c))}else{if(!h.val()&&b.ajax){require([b.ajax],function(a){e.resolve(u(f,b,c,d,a))})}else{e.resolve(r(b,c,h.val(),d))}}f.preventDefault();return!1;case g.UP:e.resolve(p(c));f.preventDefault();return!1;case g.ENTER:var i=a(document.getElementById(c.suggestionsId));if("true"===h.attr("aria-expanded")&&0<i.children("[aria-selected=true]").length){e.resolve(t(b,c,d))}else if(b.tags){e.resolve(s(b,c,d))}else{e.resolve()}f.preventDefault();return!1;case g.ESCAPE:if("true"===h.attr("aria-expanded")){e.resolve(q(c))}else{e.resolve()}f.preventDefault();return!1;}e.resolve();return!0});h.on("keypress",function(a){if(a.keyCode===g.COMMA){if(b.tags){w("keypress-"+a.keyCode).resolve(s(b,c,d))}a.preventDefault();return!1}return!0});h.on("blur",function(){var e=w("form-autocomplete-blur");window.setTimeout(function(){var f=a(document.activeElement);if(f.attr("id")!=h.attr("id")){if(b.tags){e.then(function(){return s(b,c,d)}).catch()}e.then(function(){return q(c)}).catch()}e.resolve()},500)});if(b.showSuggestions){var e=a(document.getElementById(c.downArrowId));e.on("click",function(a){var e=w("form-autocomplete-show-suggestions");h.focus();if(!h.val()&&b.ajax){require([b.ajax],function(f){e.resolve(u(a,b,c,d,f))})}else{e.resolve(r(b,c,h.val(),d))}})}var i=a(document.getElementById(c.suggestionsId));i.parent().prop("onclick",null).off("click");i.parent().on("click","[role=option]",function(f){var e=w("form-autocomplete-parent"),g=a(f.currentTarget).closest("[role=option]"),h=a(document.getElementById(c.suggestionsId)),i=h.children("[aria-hidden=false]").index(g);l(i,c).then(function(){return t(b,c,d)}).then(function(){return e.resolve()}).catch()});var j=a(document.getElementById(c.selectionId));j.on("click","[role=listitem]",function(f){var e=w("form-autocomplete-clicks");e.resolve(k(b,c,a(f.currentTarget),d))});j.on("keydown",function(f){var e=w("form-autocomplete-keydown-"+f.keyCode);switch(f.keyCode){case g.DOWN:f.preventDefault();e.resolve(o(c));return!1;case g.UP:f.preventDefault();e.resolve(n(c));return!1;case g.SPACE:case g.ENTER:var h=a(document.getElementById(c.selectionId)).children("[data-active-selection=true]");if(h){f.preventDefault();e.resolve(k(b,c,h,d))}return!1;}e.resolve();return!0});if(b.showSuggestions){if(b.ajax){require([b.ajax],function(a){var g=null,i=!1,e="autocomplete-throttledhandler",j=function(h){g=null;i=!0;u(h,b,c,d,a).then(function(){if(null===g){M.util.js_complete(e)}i=!1;return arguments[0]}).catch(f.exception)},k=function(a){window.clearTimeout(g);if(i){g=window.setTimeout(k.bind(this,a),100);return}if(null===g){M.util.js_pending(e)}g=window.setTimeout(j.bind(this,a),300)};h.on("input",k)})}else{h.on("input",function(f){var e=a(f.currentTarget).val(),g=a(f.currentTarget).data("last-value");if(g!==e){r(b,c,e,d)}a(f.currentTarget).data("last-value",e)})}}},w=function(b){var c="form-autocomplete:"+b;M.util.js_pending(c);var d=a.Deferred();d.then(function(){M.util.js_complete(c);return arguments[0]}).catch(f.exception);return d};return{enhance:function B(g,h,j,k,l,m,n,o){var p={selector:g,tags:!1,ajax:!1,placeholder:k,caseSensitive:!1,showSuggestions:!0,noSelectionString:n},q="autocomplete-setup-"+g;M.util.js_pending(q);if("undefined"!=typeof h){p.tags=h}if("undefined"!=typeof j){p.ajax=j}if("undefined"!=typeof l){p.caseSensitive=l}if("undefined"!=typeof m){p.showSuggestions=m}if("undefined"==typeof n){c.get_string("noselection","form").done(function(a){p.noSelectionString=a}).fail(f.exception)}var r=a(g);if(!r){b.debug("Selector not found: "+g);M.util.js_complete(q);return!1}r.css("visibility","hidden").attr("aria-hidden",!0);var s={selectId:r.attr("id"),inputId:"form_autocomplete_input-"+e,suggestionsId:"form_autocomplete_suggestions-"+e,selectionId:"form_autocomplete_selection-"+e,downArrowId:"form_autocomplete_downarrow-"+e};e++;p.multiple=r.attr("multiple");if("undefined"!=typeof o){p.closeSuggestionsOnSelect=o}else{p.closeSuggestionsOnSelect=!p.multiple}var t=a("[for="+s.selectId+"]"),u=[];r.children("option").each(function(b,c){u[b]={label:c.innerHTML,value:a(c).attr("value")}});var w=a.extend({},p,s);w.options=u;w.items=[];var x="",y=d.render("core/form_autocomplete_input",w).then(function(a,b){x+=b;return a}),z=d.render("core/form_autocomplete_suggestions",w).then(function(a,b){x+=b;return a}),A=d.render("core/form_autocomplete_selection",w).then(function(a,b){x+=b;return a});return a.when(y,z,A).then(function(b,c,e){r.hide();r.after(c);r.after(b);r.after(e);d.runTemplateJS(x);t.attr("for",s.inputId);v(p,s,r);var f=a(document.getElementById(s.suggestionsId));f.hide().attr("aria-hidden",!0)}).then(function(){return i(p,s,r)}).then(function(){return M.util.js_complete(q)}).catch(function(a){M.util.js_complete(q);f.exception(a)})}}});
//# sourceMappingURL=form-autocomplete.es6.js.map
