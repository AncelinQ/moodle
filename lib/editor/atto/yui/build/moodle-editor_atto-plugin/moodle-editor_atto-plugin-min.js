YUI.add("moodle-editor_atto-plugin",function(e,t){function n(){n.superclass.constructor.apply(this,arguments)}function p(){}function d(){}var r=".atto_group.",i="_group";e.extend(n,e.Base,{name:null,toolbar:null,editor:null,initializer:function(e){this.name=e.name,this.toolbar=e.toolbar,this.editor=e.editor,this.buttons={},this.buttonNames=[],this.buttonStates={},this.menus={},this._buttonHandlers=[],this._menuHideHandlers=[]},markUpdated:function(){return this.get("host").updateOriginal()}},{NAME:"editorPlugin",ATTRS:{host:{writeOnce:!0},group:{writeOnce:!0,getter:function(t){var n=this.toolbar.one(r+t+i);return n||(n=e.Node.create('<div class="atto_group '+t+i+'"></div>'),this.toolbar.append(n)),n}}}}),e.namespace("M.editor_atto").EditorPlugin=n;var s='<button class="{{buttonClass}} atto_hasmenu" tabindex="-1" type="button" title="{{title}}"><img class="icon" aria-hidden="true" role="presentation" width="16" height="16" style="background-color:{{config.menuColor}};" src="{{config.iconurl}}" /><img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="{{image_url "t/expanded" "moodle"}}"/></button>',o='<div class="{{config.buttonClass}} atto_menu" style="min-width:{{config.innerOverlayWidth}};"><ul class="menu">{{#each config.items}}<li role="presentation" class="atto_menuentry"><a href="#" role="menuitem" data-index="{{@index}}">{{{text}}}</a></li>{{/each}}</ul></div>',u="disabled",a=0,f=1,l="highlight",c="moodle-editor_atto-editor-plugin",h=".editor_atto_content";p.ATTRS={},p.prototype={buttons:null,buttonNames:null,buttonStates:null,menus:null,_buttonHandlers:null,_menuHideHandlers:null,addButton:function(t){var n=this.get("group"),r=this.name,i="atto_"+r+"_button",s,o=this.get("host");t.exec&&(i=i+"_"+t.exec),t.buttonName?i=i+"_"+t.buttonName:t.buttonName=t.exec||r,t=this._normalizeIcon(t),t.title||(t.title="pluginname");var u=M.util.get_string(t.title,"atto_"+r);s=e.Node.create('<button class="'+i+'"'+'tabindex="-1">'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="'+t.iconurl+'"/>'+"</button>"),s.setAttribute("title",u),n.append(s);var a=this.toolbar.getAttribute("aria-activedescendant");a||(s.setAttribute("tabindex","0"),this.toolbar.setAttribute("aria-activedescendant",s.generateID())),t=this._normalizeCallback(t),this._buttonHandlers.push(this.toolbar.delegate("click",t.callback,"."+i,this)),t.keys&&this.addKeyboardListener(t.callback,t.keys,i);if(t.tags){var l=null;typeof t.tagMatchRequiresAll=="boolean"&&(l=t.tagMatchRequiresAll),this._buttonHandlers.push(o.on("atto:selectionchanged",function(e){o.selectionFilterMatches(t.tags,e.selectedNodes,l)?this.highlightButton(t.buttonName):this.unHighlightButton(t.buttonName)},this))}return this.buttonNames.push(t.buttonName),this.buttons[t.buttonName]=s,this.buttonStates[t.buttonName]=f,s},addBasicButton:function(e){return e.exec?(e.icon||(e.icon="e/"+e.exec),e.callback=function(){document.execCommand(e.exec,!1,null),this.fire(e.exec+":complete"),this.markUpdated()},this.addButton(e)):null},addToolbarMenu:function(t){var n=this.get("group"),r=this.name,i="atto_"+r+"_button",o,u;t.buttonName?i=i+"_"+t.buttonName:t.buttonName=r,t=this._normalizeIcon(t),t.title||(t.title="pluginname");var a=M.util.get_string(t.title,"atto_"+r);t.menuColor||(t.menuColor="transparent");var l=e.Handlebars.compile(s);return o=e.Node.create(l({buttonClass:i,config:t,title:a})),n.append(o),u=this.toolbar.getAttribute("aria-activedescendant"),u||(o.setAttribute("tabindex","0"),this.toolbar.setAttribute("aria-activedescendant",o.generateID())),this._buttonHandlers.push(this.toolbar.delegate("click",this._showToolbarMenu,"."+i,this,t),this.toolbar.delegate("key",this._showToolbarMenu,"40, 32, enter","."+i,this,t)),this.buttonNames.push(t.buttonName),this.buttons[t.buttonName]=o,this.buttonStates[t.buttonName]=f,o},_showToolbarMenu:function(t,n){t.preventDefault();if(!this.isEnabled())return;if(t.currentTarget.ancestor("button",!0).hasAttribute(u))return;if(!this.menus[n.buttonClass]){n.overlayWidth||(n.overlayWidth="14"),n.innerOverlayWidth||(n.innerOverlayWidth=parseInt(n.overlayWidth,10)-2+"em"),n.overlayWidth=parseInt(n.overlayWidth,10)+"em";var r=e.Handlebars.compile(o),i=e.Node.create(r({config:n}));this._buttonHandlers.push(i.delegate("click",this._chooseMenuItem,".atto_menuentry a",this,n),i.delegate("key",this._chooseMenuItem,"32, enter",".atto_menuentry",this,n)),this.menus[n.buttonClass]=new M.core.dialogue({bodyContent:i,width:null,visible:!1,center:!1,closeButton:!1,responsive:!1,extraClasses:["editor_atto_menu"]}),this.menus[n.buttonClass].headerNode.hide()}var s=this.buttons[n.buttonName];this.get("host")._setTabFocus(s);var a=this.menus[n.buttonClass];a.set("focusAfterHide",s),a.show(),a.align(this.buttons[n.buttonName],[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),a.get("boundingBox").one("a").focus(),this._menuHideHandlers.push(a.get("boundingBox").on("focusoutside",this._hideMenu,this,a))},_hideMenu:function(t,n){n.hide(),(new e.EventHandle(this._menuHideHandlers)).detach()},_chooseMenuItem:function(e,t){var n=e.target.ancestor("a",!0).getData("index"),r=this._normalizeCallback(t.items[n],t.globalItemConfig);r.callback(e,r._callback,r.callbackArgs)},_showHideMenu:function(t){t.preventDefault();var n=this.getAttribute("disabled"),r=this.getAttribute("data-menu"),i=M.editor_atto.menus[r],s=i.get("bodyContent");if(i.get("visible")||n)i.hide(),s.detach("clickoutside");else{s.on("clickoutside",function(e){e.target.ancestor()!==this&&e.target!==this&&i.get("visible")&&(s.detach("clickoutside"),i.hide())},this),i.align(e.one(e.config.doc.body),[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),i.show();var o=t.target.ancestor("button",!0).one("img");i.align(o,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),i.get("boundingBox").one("a").focus()}},_normalizeCallback:function(t,n){return t._callbackNormalized?t:(n||(n={}),typeof t.wrapCallback=="undefined"&&(t.wrapCallback=n.wrapCallback||!0
),t.wrapCallback?(t._callback=t.callback||n.callback,t.callback=e.rbind(this._callbackWrapper,this,t._callback,t.callbackArgs)):t.callback=t.callback||n.callback,t._callbackNormalized=!0,t)},_normalizeIcon:function(e){return e.iconurl||(e.iconComponent||(e.iconComponent="core"),e.iconurl=M.util.image_url(e.icon,e.iconComponent)),e},_callbackWrapper:function(e,t,n){e.preventDefault();if(!this.isEnabled())return;var r=e.currentTarget.ancestor("button",!0);if(r&&r.hasAttribute(u))return;this.get("host").isActive()||this.get("host").focus(),r&&this.get("host")._setTabFocus(r);var i=[e,n];t.apply(this,i)},addKeyboardListener:function(t,n,r){var i="key",s=h,o;if(e.Lang.isArray(n))return e.Array.each(n,function(e){this.addKeyboardListener(t,e)},this),this;typeof n=="object"?(n.eventtype&&(i=n.eventtype),n.container&&(s=n.container),o=n.keyCodes):o=this.getKeyEvent()+n+this.getDefaultMetaKey(),this._buttonHandlers.push(this.editor.delegate(i,t,o,s,this))},isEnabled:function(){var t=e.Object.some(this.buttonStates,function(e){return e===f});return t},disableButtons:function(e){return this._setButtonState(!1,e)},enableButtons:function(e){return this._setButtonState(!0,e)},_setButtonState:function(t,n){var r="setAttribute";return t&&(r="removeAttribute"),n?this.buttons[n]&&(this.buttons[n][r](u,u),this.buttonStates[n]=t?f:a):e.Array.each(this.buttonNames,function(e){this.buttons[e][r](u,u),this.buttonStates[e]=t?f:a},this),this},highlightButton:function(e){this._changeButtonHighlight(!0,e)},unHighlightButton:function(e){this._changeButtonHighlight(!1,e)},_changeButtonHighlight:function(t,n){var r="addClass";t||(r="removeClass"),n?this.buttons[n]&&this.buttons[n][r](l):e.Object.each(this.buttons,function(){this[r](l)},this)},getDefaultMetaKey:function(){return e.UA.os==="macintosh"?"+meta":"+ctrl"},getKeyEvent:function(){return"down:"}},e.Base.mix(e.M.editor_atto.EditorPlugin,[p]),d.ATTRS={},d.prototype={_dialogue:null,getDialogue:function(t){t=t||{};var n=!1;t.focusAfterHide&&(n=t.focusAfterHide,delete t.focusAfterHide);if(!this._dialogue){var r=e.merge({visible:!1,modal:!0,close:!0,draggable:!0},t);this._dialogue=new M.core.dialogue(r)}return n!==!1&&(n===!0?this._dialogue.set("focusAfterHide",this.buttons[this.buttonNames[0]]):typeof setFocusAfter=="string"?this._dialogue.set("focusAfterHide",this.buttons[n]):this._dialogue.set("focusAfterHide",n)),this._dialogue}},e.Base.mix(e.M.editor_atto.EditorPlugin,[d])},"@VERSION@",{requires:["node","base","escape","event","event-outside","handlebars","event-custom"]});
