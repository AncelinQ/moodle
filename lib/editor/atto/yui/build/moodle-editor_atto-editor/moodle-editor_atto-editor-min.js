YUI.add("moodle-editor_atto-editor",function(e,t){function i(){i.superclass.constructor.apply(this,arguments)}var n={CONTENT:"editor_atto_content",CONTENTWRAPPER:"editor_atto_content_wrap",TOOLBAR:"editor_atto_toolbar",WRAPPER:"editor_atto"},r=["address","article","aside","audio","blockquote","canvas","dd","div","dl","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","noscript","ol","output","p","pre","section","table","tfoot","ul","video"];e.extend(i,e.Base,{_plugins:{},editorEvents:[],initializer:function(){var t=this.get("textarea"),r=t.get("id"),i=e.Node.create('<div class="'+n.WRAPPER+'" />'),s=e.Node.create('<div id="'+r+'editable" '+'contenteditable="true" '+'role="textbox" '+'spellcheck="true" '+'aria-live="off" '+'class="'+n.CONTENT+'" />'),o=e.Node.create('<div class="'+n.TOOLBAR+'" role="toolbar" aria-live="off"/>'),u=e.Node.create('<div class="'+n.CONTENTWRAPPER+'" />'),a=e.one('[for="'+r+'"]');a&&(a.generateID(),s.setAttribute("aria-labelledby",a.get("id")),o.setAttribute("aria-labelledby",a.get("id"))),u.appendChild(s),i.appendChild(o),i.appendChild(u),s.setStyle("minHeight",1.2*t.getAttribute("rows")+"em"),s.append(t.get("value")),this.setAttrs({editor:s,toolbar:o}),this.cleanEditorHTML(),t.get("parentNode").insert(i,t),t.hide();try{document.execCommand("styleWithCSS",0,!1)}catch(f){try{document.execCommand("useCSS",0,!0)}catch(l){try{document.execCommand("styleWithCSS",!1,!1)}catch(c){}}}this.setupChangeHandlers(),this.publishEvents(),this.setupPlugins()},setupChangeHandlers:function(){var e=this.get("editor"),t=this.get("toolbar");this.editorEvents.push(e.on("keydown, mouseup",this.saveSelection,this),e.on("focus",this.restoreSelection,this),e.on("mousedown",function(){this.focusfromclick=!0},this),e.on("blur",function(){this.focusfromclick=!1,this.updateOriginal()},this),t.on("key",this.toolbarNavigation,"down:37,39",this))},publishEvents:function(){return this.publish("change",{broadcast:!0,preventable:!0}),this},setupPlugins:function(){var t=this.get("plugins"),n,r,i,s,o,u=this.get("editor"),a=this.get("toolbar");for(n in t){r=t[n];if(!r.plugins)continue;for(i in r.plugins){s=r.plugins[i],o=e.mix({name:s.name,group:r.group,editor:u,toolbar:a,host:this},s);if(typeof e.M["atto_"+s.name]=="undefined")continue;this._plugins[s.name]=new e.M["atto_"+s.name].Button(o)}}return this},getEditor:function(){return e.one(document.getElementById(elementid+"editable"))},get_toolbar_node:function(t){return e.one(document.getElementById(t+"_toolbar"))},focus:function(){return this.get("editor").focus(),this},isActive:function(){var t=this.getSelection();t.length&&(t=t.pop());var n=null;return t.parentElement?n=e.one(t.parentElement()):n=e.one(t.startContainer),n&&this.get("editor").contains(n)},can_show_filepicker:function(e,t){var n=this.get("filepickeroptions")[e];return typeof n[t]!="undefined"},show_filepicker:function(t,n,r){e.use("core_filepicker",function(e){var i=this.get("filepickeroptions")[t][n];i.formcallback=r,M.core_filepicker.show(e,i)})},updateOriginal:function(){var e=this.get("textarea");e.set("value",this.getCleanHTML()),e.simulate("change"),this.fire("change")},getCleanHTML:function(){var t=this.get("editor").cloneNode(!0);return e.each(t.all('[id^="yui"]'),function(e){e.removeAttribute("id")}),t.all(".atto_control").remove(!0),this._cleanHTML(t.get("innerHTML"))},cleanEditorHTML:function(){var e=this.get("editor").get("innerHTML");return this.get("editor").set("innerHTML",this._cleanHTML(e)),this},_cleanHTML:function(e){var t=[{regex:/<!--[\s\S]*?-->/gi,replace:""},{regex:/<\\?\?xml[^>]*>/gi,replace:""},{regex:/<\/?\w+:[^>]*>/gi,replace:""},{regex:/\s*MSO[-:][^;"']*;?/gi,replace:""},{regex:/<span[^>]*>(&nbsp;|\s)*<\/span>/gi,replace:""},{regex:/class="Mso[^"]*"/gi,replace:""},{regex:/<(\/?title|\/?meta|\/?style|\/?st\d|\/?head|\/?font|\/?html|\/?body|!\[)[^>]*?>/gi,replace:""},{regex:new RegExp(String.fromCharCode(8220),"gi"),replace:'"'},{regex:new RegExp(String.fromCharCode(8216),"gi"),replace:"'"},{regex:new RegExp(String.fromCharCode(8217),"gi"),replace:"'"},{regex:new RegExp(String.fromCharCode(8211),"gi"),replace:"-"},{regex:new RegExp(String.fromCharCode(8212),"gi"),replace:"--"},{regex:new RegExp(String.fromCharCode(189),"gi"),replace:"1/2"},{regex:new RegExp(String.fromCharCode(188),"gi"),replace:"1/4"},{regex:new RegExp(String.fromCharCode(190),"gi"),replace:"3/4"},{regex:new RegExp(String.fromCharCode(169),"gi"),replace:"(c)"},{regex:new RegExp(String.fromCharCode(174),"gi"),replace:"(r)"},{regex:new RegExp(String.fromCharCode(8230),"gi"),replace:"..."}],n=0;for(n=0;n<t.length;n++)e=e.replace(t[n].regex,t[n].replace);return e},toolbarNavigation:function(t){var n,r,i,s,o=this.get("toolbar");t.preventDefault(),n=o.all("empty"),o.all(".atto_group").each(function(e){e.hasAttribute("hidden")||(n=n.concat(e.all("button")))}),i=o.getAttribute("aria-activedescendant");if(!i)return;r=e.one("#"+i),r.setAttribute("tabindex","-1"),s=n.indexOf(r),t.keyCode===37?(s--,s<0&&(s=n.size()-1)):(s++,s>=n.size()&&(s=0)),r=n.item(s),r.setAttribute("tabindex","0"),r.focus(),o.setAttribute("aria-activedescendant",r.generateID())},getSelection:function(){if(window.getSelection){var e=window.getSelection(),t=[],n=0;for(n=0;n<e.rangeCount;n++)t.push(e.getRangeAt(n));return t}return document.selection&&document.selection.createRange?document.selection.createRange():!1},getSelectionText:function(){var e=this.getSelection();if(e.length>0&&e[0].cloneContents)return e[0].cloneContents()},setSelection:function(e){var t,n;if(window.getSelection){t=window.getSelection(),t.removeAllRanges();for(n=0;n<e.length;n++)t.addRange(e[n])}else document.selection&&e.select&&e.select()},selectionContainsNode:function(e){var t,n;if(window.getSelection){n=window.getSelection();if(n.containsNode)return n.containsNode(e.getDOMNode(),!0)}return n=document.selection.createRange(),t=n.duplicate(),t.moveToElementText(e.getDOMNode()),n.inRange(t)},getSelectionParentNode
:function(){var e=this.getSelection();return e.length&&(e=e.pop()),e.commonAncestorContainer?e.commonAncestorContainer:e.parentElement?e.parentElement():!1},getSelection_from_node:function(e){var t;return window.getSelection?(t=document.createRange(),t.setStartBefore(e.getDOMNode()),t.setEndAfter(e.getDOMNode()),[t]):document.selection?(t=document.body.createTextRange(),t.moveToElementText(e.getDOMNode()),t):!1},getSelectedNodes:function(){var e=this.getSelection();if(e.length>0&&e[0].cloneContents)return e[0].cloneContents()},saveSelection:function(){if(this.isActive()){var e=this.getSelection();e.length>0&&(this.selection=e)}return this},restoreSelection:function(e){return e.preventDefault(),this.focusfromclick||typeof this.selection!="undefined"&&this.setSelection(this.selection),this.focusfromclick=!1,this},formatSelectionBlock:function(t,n){var i=this.getSelectionParentNode(),s,o,u,a,f,l;if(!i)return;s=this.getEditor(elementid),i=e.one(i),o=i.ancestor(function(e){var t=e.get("tagName");return t&&(t=t.toLowerCase()),e===s||t==="td"||t==="th"},!0),o&&(s=o),u=i.ancestor(r.join(", "),!0),u&&(f=u.ancestor(function(e){return e===s},!1),f||(u=!1)),u||(a=e.Node.create("<p></p>"),s.get("childNodes").each(function(e){a.append(e.remove())}),s.append(a),u=a),t&&t!==""&&(l=e.Node.create("<"+t+"></"+t+">"),l.setAttrs(u.getAttrs()),u.get("childNodes").each(function(e){e.remove(),l.append(e)}),u.replace(l),u=l),n&&u.setAttrs(n);var c=this.getSelection_from_node(u);return this.setSelection(c),u},buttonhandlers:{},menus:{},menuhandlers:{},filepickeroptions:{},widgets:{},selections:{},focusfromclick:!1,showhide_menu_handler:function(t){t.preventDefault();var n=this.getAttribute("disabled"),r=this.getAttribute("data-menu"),i=this.menus[r],s=i.get("bodyContent");if(i.get("visible")||n)i.hide(),s.detach("clickoutside");else{s.on("clickoutside",function(e){e.target.ancestor()!==this&&e.target!==this&&i.get("visible")&&(s.detach("clickoutside"),i.hide())},this),i.align(e.one(e.config.doc.body),[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),i.show();var o=t.target.ancestor("button",!0).one("img");i.align(o,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),i.get("boundingBox").one("a").focus()}},buttonclicked_handler:function(t){var n=this.getAttribute("data-editor"),r=this.getAttribute("data-plugin"),i=this.getAttribute("data-handler"),s=this.menus[r+"_"+n],o=this.get_toolbar_node(n),u=o.getAttribute("aria-activedescendant");u&&(current=e.one("#"+u),current.setAttribute("tabindex","-1")),this.setAttribute("tabindex",0),o.setAttribute("aria-activedescendant",this.generateID()),s&&s.hide();if(this.is_enabled(n,r))return i=this.buttonhandlers[i],i(t,n)},disable_all_widgets:function(e){var t,n,r=this.get_toolbar_node(e);for(t in this.widgets)n=r.one(".atto_"+t+"_button"),n&&n.setAttribute("disabled","true")},is_enabled:function(e,t){var n=this.get_toolbar_node(e).one(".atto_"+t+"_button");return!n.hasAttribute("disabled")},enable_widget:function(e,t){var n=this.get_toolbar_node(e).one(".atto_"+t+"_button");n&&n.removeAttribute("disabled")},enable_all_widgets:function(e){var t,n;for(t in this.widgets)n=this.get_toolbar_node(e).one(".atto_"+t+"_button"),n&&n.removeAttribute("disabled")},add_toolbar_menu:function(t,n,r,i,s,o,u){var a=this.get_toolbar_node(t),f=a.one(".atto_group."+i+"_group"),l,c,h;typeof o=="undefined"&&(o="14"),typeof u=="undefined"&&(u="transparent"),f||(f=e.Node.create('<div class="atto_group '+i+'_group"></div>'),a.append(f)),h=M.util.image_url("t/expanded","moodle"),c=e.Node.create('<button class="atto_'+n+'_button atto_hasmenu" '+'data-editor="'+e.Escape.html(t)+'" '+'tabindex="-1" '+'type="button" '+'data-menu="'+n+"_"+t+'" '+'title="'+e.Escape.html(M.util.get_string("pluginname","atto_"+n))+'">'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" '+'style="background-color:'+u+';" src="'+r+'"/>'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="'+h+'"/>'+"</button>"),f.append(c),l=a.getAttribute("aria-activedescendant"),l||(c.setAttribute("tabindex","0"),a.setAttribute("aria-activedescendant",c.generateID())),this.widgets[n]=n;var p=e.Node.create('<div class="atto_'+n+"_menu"+' atto_menu" data-editor="'+e.Escape.html(t)+'"'+' style="min-width:'+(o-2)+'em"'+'"></div>'),d=0,v={};for(d=0;d<s.length;d++)v=s[d],p.append(e.Node.create('<div class="atto_menuentry"><a href="#" class="atto_'+n+"_action_"+d+'" '+'data-editor="'+e.Escape.html(t)+'" '+'data-plugin="'+e.Escape.html(n)+'" '+'data-handler="'+e.Escape.html(n+"_action_"+d)+'">'+v.text+"</a>"+"</div>")),this.buttonhandlers[n+"_action_"+d]||(e.one("body").delegate("click",this.buttonclicked_handler,".atto_"+n+"_action_"+d),e.one("body").delegate("key",this.buttonclicked_handler,"space,enter",".atto_"+n+"_action_"+d),this.buttonhandlers[n+"_action_"+d]=v.handler);this.buttonhandlers[n]||(e.one("body").delegate("click",this.showhide_menu_handler,".atto_"+n+"_button"),this.buttonhandlers[n]=!0);var m=new M.core.dialogue({bodyContent:p,visible:!1,width:o+"em",lightbox:!1,closeButton:!1,center:!1});this.menus[n+"_"+t]=m,m.align(c,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),m.hide(),m.headerNode.hide(),m.render()},add_toolbar_button:function(t,n,r,i,s){var o=this.get_toolbar_node(t),u=o.one(".atto_group."+i+"_group"),a,f;return u||(u=e.Node.create('<div class="atto_group '+i+'_group"></div>'),o.append(u)),a=e.Node.create('<button class="atto_'+n+'_button" '+'data-editor="'+e.Escape.html(t)+'" '+'data-plugin="'+e.Escape.html(n)+'" '+'tabindex="-1" '+'data-handler="'+e.Escape.html(n)+'" '+'title="'+e.Escape.html(M.util.get_string("pluginname","atto_"+n))+'">'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="'+r+'"/>'+"</button>"),u.append(a),f=o.getAttribute("aria-activedescendant"),f||(a.setAttribute("tabindex","0"),o.setAttribute("aria-activedescendant",a.generateID())),this.buttonhandlers[n]||(e.one("body").delegate("click",this
.buttonclicked_handler,".atto_"+n+"_button"),this.buttonhandlers[n]=s),this.widgets[n]=n,a},format_selection_block:function(t,n,i){var s=this.getSelectionParentNode(),o,u,a,f,l,c;if(!s)return;o=this.getEditor(t),s=e.one(s),u=s.ancestor(function(e){var t=e.get("tagName");return t&&(t=t.toLowerCase()),e===o||t==="td"||t==="th"},!0),u&&(o=u),a=s.ancestor(r.join(", "),!0),a&&(l=a.ancestor(function(e){return e===o},!1),l||(a=!1)),a||(f=e.Node.create("<p></p>"),o.get("childNodes").each(function(e){f.append(e.remove())}),o.append(f),a=f),n&&n!==""&&(c=e.Node.create("<"+n+"></"+n+">"),c.setAttrs(a.getAttrs()),a.get("childNodes").each(function(e){e.remove(),c.append(e)}),a.replace(c),a=c),i&&a.setAttrs(i);var h=this.getSelection_from_node(a);return this.setSelection(h),a}},{NAME:"editor",ATTRS:{elementid:{value:null,setter:function(e){return this.set("textarea",e),e}},editor:{writeOnce:!0},toolbar:{writeOnce:!0},textarea:{value:null,writeOnce:!0,setter:function(t){var n=e.one(document.getElementById(t));return n?n:e.Attribute.INVALID_VALUE}},filepickeroptions:{value:{}},plugins:{value:{}}}}),e.namespace("M.editor_atto.editor").init=function(e){return new i(e)};var s="Controlmenu",o;o=function(e){e.draggable=!1,e.center=!1,e.width="auto",e.lightbox=!1,e.footerContent="",o.superclass.constructor.apply(this,[e])},e.extend(o,M.core.dialogue,{initializer:function(t){var n,r,i;o.superclass.initializer.call(this,t),i=this.get("boundingBox"),i.addClass("editor_atto_controlmenu"),n=this.bodyNode,r=e.Node.create("<h3/>"),r.addClass("accesshide"),r.setHTML(this.get("headerText")),n.prepend(r),n.on("clickoutside",function(e){this.get("visible")&&(e.target.ancestor(".atto_control")||(e.preventDefault(),this.hide()))},this)}},{NAME:s,ATTRS:{headerText:{value:""}}}),M.editor_atto=M.editor_atto||{},M.editor_atto.controlmenu=o},"@VERSION@",{requires:["node","base","io","overlay","escape","event","event-simulate","moodle-core-notification"]});
