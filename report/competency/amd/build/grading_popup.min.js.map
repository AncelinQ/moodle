{"version":3,"sources":["../src/grading_popup.js"],"names":["define","$","notification","str","ajax","log","templates","Dialogue","Pending","GradingPopup","regionSelector","userCompetencySelector","_regionSelector","_userCompetencySelector","on","_handleClick","bind","prototype","e","pendingPromise","cell","target","closest","competencyId","data","courseId","userId","debug","requests","call","methodname","args","userid","competencyid","courseid","when","then","_contextLoaded","always","resolve","catch","exception","context","displayuser","render","get_string","htmljs","title","runTemplateJS","_refresh","region","moduleId","moduleid","_pageContextLoaded","html","js","replaceNode"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to enable inline editing of a comptency grade.\n *\n * @package    report_competency\n * @copyright  2015 Damyon Wiese\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/notification', 'core/str', 'core/ajax', 'core/log', 'core/templates', 'tool_lp/dialogue', 'core/pending'],\n       function($, notification, str, ajax, log, templates, Dialogue, Pending) {\n\n    /**\n     * GradingPopup\n     *\n     * @param {String} regionSelector The regionSelector\n     * @param {String} userCompetencySelector The userCompetencySelector\n     */\n    var GradingPopup = function(regionSelector, userCompetencySelector) {\n        this._regionSelector = regionSelector;\n        this._userCompetencySelector = userCompetencySelector;\n\n        $(this._regionSelector).on('click', this._userCompetencySelector, this._handleClick.bind(this));\n    };\n\n    /**\n     * Get the data from the clicked cell and open the popup.\n     *\n     * @method _handleClick\n     * @param {Event} e The event\n     */\n    GradingPopup.prototype._handleClick = function(e) {\n        var pendingPromise = new Pending('report_competency/grading_popup:_handleClick');\n\n        var cell = $(e.target).closest(this._userCompetencySelector);\n        var competencyId = $(cell).data('competencyid');\n        var courseId = $(cell).data('courseid');\n        var userId = $(cell).data('userid');\n\n        log.debug('Clicked on cell: competencyId=' + competencyId + ', courseId=' + courseId + ', userId=' + userId);\n\n        var requests = ajax.call([\n            {\n                methodname: 'tool_lp_data_for_user_competency_summary_in_course',\n                args: {userid: userId, competencyid: competencyId, courseid: courseId},\n            },\n            {\n                methodname: 'core_competency_user_competency_viewed_in_course',\n                args: {userid: userId, competencyid: competencyId, courseid: courseId},\n            }\n        ]);\n\n        $.when(requests[0], requests[1])\n        .then(this._contextLoaded.bind(this))\n        .always(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * We loaded the context, now render the template.\n     *\n     * @method _contextLoaded\n     * @param {Object} context\n     */\n    GradingPopup.prototype._contextLoaded = function(context) {\n        var pendingPromise = new Pending('report_competency/grading_popup:_contextLoaded');\n\n        // We have to display user info in popup.\n        context.displayuser = true;\n        $.when(\n            templates.render('tool_lp/user_competency_summary_in_course', context),\n            str.get_string('usercompetencysummary', 'report_competency')\n        )\n        .then(function(htmljs, title) {\n            return new Dialogue(\n                title,\n                htmljs[0],\n                templates.runTemplateJS.bind(templates, htmljs[1]),\n                this._refresh.bind(this),\n                true\n            );\n        }.bind(this))\n        .always(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * Refresh the page.\n     *\n     * @method _refresh\n     */\n    GradingPopup.prototype._refresh = function() {\n        var pendingPromise = new Pending('report_competency/grading_popup:_refresh');\n\n        var region = $(this._regionSelector);\n        var courseId = region.data('courseid');\n        var moduleId = region.data('moduleid');\n        var userId = region.data('userid');\n\n        // The module id is expected to be an integer, so don't pass empty string.\n        if (moduleId === '') {\n            moduleId = 0;\n        }\n\n        ajax.call([{\n            methodname: 'report_competency_data_for_report',\n            args: {\n                courseid: courseId,\n                userid: userId,\n                moduleid: moduleId,\n            },\n        }])[0]\n        .then(this._pageContextLoaded.bind(this))\n        .always(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * We loaded the context, now render the template.\n     *\n     * @method _pageContextLoaded\n     * @param {Object} context\n     */\n    GradingPopup.prototype._pageContextLoaded = function(context) {\n        var pendingPromise = new Pending('report_competency/grading_popup:_pageContextLoaded');\n\n        templates.render('report_competency/report', context)\n        .then(function(html, js) {\n            templates.replaceNode(this._regionSelector, html, js);\n\n            return;\n        }.bind(this))\n        .always(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /** @type {String} The selector for the region with the user competencies */\n    GradingPopup.prototype._regionSelector = null;\n    /** @type {String} The selector for the region with a single user competencies */\n    GradingPopup.prototype._userCompetencySelector = null;\n\n    return /** @alias module:report_competency/grading_popup */ GradingPopup;\n\n});\n"],"file":"grading_popup.min.js"}