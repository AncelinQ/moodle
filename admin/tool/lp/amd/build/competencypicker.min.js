define(["jquery","core/notification","core/ajax","core/templates","tool_lp/dialogue","core/str","tool_lp/tree","core/pending"],function(a,b,c,d,e,f,g,h){var i=function(b,c,d,e){var f=this;f._eventNode=a("<div></div>"),f._frameworks=[],f._reset(),f._pageContextId=b,f._pageContextIncludes=d||"children",f._multiSelect="undefined"==typeof e||e===!0,c&&(f._frameworkId=c,f._singleFramework=!0)};return i.prototype._competencies=null,i.prototype._disallowedCompetencyIDs=null,i.prototype._eventNode=null,i.prototype._frameworks=null,i.prototype._frameworkId=null,i.prototype._pageContextId=null,i.prototype._pageContextIncludes=null,i.prototype._popup=null,i.prototype._searchText="",i.prototype._selectedCompetencies=null,i.prototype._singleFramework=!1,i.prototype._multiSelect=!0,i.prototype._onlyVisible=!0,i.prototype._afterRender=function(c){var d=this,e=new g(d._find("[data-enhance=linktree]"),d._multiSelect);d._find("[data-enhance=linktree]").show(),e.on("selectionchanged",function(b,c){var e=c.selected;b.preventDefault();var f=[];a.each(e,function(b,c){var e=a(c).data("id"),g=!0;"undefined"==typeof e?g=!1:a.each(d._disallowedCompetencyIDs,function(a,b){b==e&&(g=!1)}),g&&f.push(e)}),d._selectedCompetencies=f,d._selectedCompetencies.length?d._find('[data-region="competencylinktree"] [data-action="add"]').removeAttr("disabled"):d._find('[data-region="competencylinktree"] [data-action="add"]').attr("disabled","disabled")}),d._singleFramework||d._find('[data-action="chooseframework"]').change(function(c){d._frameworkId=a(c.target).val(),d._loadCompetencies().then(d._refresh.bind(d))["catch"](b.exception)}),d._find('[data-region="filtercompetencies"] button').click(function(b){return b.preventDefault(),a(b.target).attr("disabled","disabled"),d._searchText=d._find('[data-region="filtercompetencies"] input').val()||"",d._refresh().always(function(){a(b.target).removeAttr("disabled")})}),d._find('[data-region="competencylinktree"] [data-action="cancel"]').click(function(a){a.preventDefault(),d.close()}),d._find('[data-region="competencylinktree"] [data-action="add"]').click(function(a){a.preventDefault(),d._selectedCompetencies.length&&(d._multiSelect?d._trigger("save",{competencyIds:d._selectedCompetencies}):d._trigger("save",{competencyId:d._selectedCompetencies[0]}),d.close())});var f=d._selectedCompetencies.slice(0);a.each(f,function(a,b){var c=d._find("[data-id="+b+"]");c.length&&(e.toggleItem(c),e.updateFocus(c))}),c.resolve()},i.prototype.close=function(){var a=this;a._popup.close(),a._reset()},i.prototype.display=function(){var c=this,d=new h;return a.when(f.get_string("competencypicker","tool_lp"),c._render()).then(function(a,b){c._popup=new e(a,b[0],c._afterRender.bind(c,d))})["catch"](b.exception)},i.prototype._fetchCompetencies=function(a,d){var e=this;return c.call([{methodname:"core_competency_search_competencies",args:{searchtext:d,competencyframeworkid:a}}])[0].done(function(a){function b(a,c){for(var d=0;d<c.length;d++)c[d].parentid==a.id&&(a.haschildren=!0,c[d].children=[],c[d].haschildren=!1,a.children[a.children.length]=c[d],b(c[d],c))}var c,d,f=[];for(c=0;c<a.length;c++)d=a[c],"0"==d.parentid&&(d.children=[],d.haschildren=0,f[f.length]=d,b(d,a));e._competencies=f}).fail(b.exception)},i.prototype._find=function(b){return a(this._popup.getContent()).find(b)},i.prototype._getFramework=function(b){var c;return a.each(this._frameworks,function(a,d){if(d.id==b)return void(c=d)}),c},i.prototype._loadCompetencies=function(){return this._fetchCompetencies(this._frameworkId,this._searchText)},i.prototype._loadFrameworks=function(){var d,e=this;return e._frameworks.length>0?a.when():(d=e._singleFramework?c.call([{methodname:"core_competency_read_competency_framework",args:{id:this._frameworkId}}])[0].then(function(a){return[a]}):c.call([{methodname:"core_competency_list_competency_frameworks",args:{sort:"shortname",context:{contextid:e._pageContextId},includes:e._pageContextIncludes,onlyvisible:e._onlyVisible}}])[0],d.done(function(a){e._frameworks=a}).fail(b.exception))},i.prototype.on=function(a,b){this._eventNode.on(a,b)},i.prototype._preRender=function(){var b=this;return b._loadFrameworks().then(function(){return!b._frameworkId&&b._frameworks.length>0&&(b._frameworkId=b._frameworks[0].id),b._frameworkId?b._loadCompetencies():(b._frameworks=[],a.when())})},i.prototype._refresh=function(){var a=this,b=new h;return a._render().then(function(c){a._find('[data-region="competencylinktree"]').replaceWith(c),a._afterRender(a,b)})},i.prototype._render=function(){var b=this;return b._preRender().then(function(){b._singleFramework||a.each(b._frameworks,function(a,c){c.id==b._frameworkId?c.selected=!0:c.selected=!1});var c={competencies:b._competencies,framework:b._getFramework(b._frameworkId),frameworks:b._frameworks,search:b._searchText,singleFramework:b._singleFramework};return d.render("tool_lp/competency_picker",c)})},i.prototype._reset=function(){this._competencies=[],this._disallowedCompetencyIDs=[],this._popup=null,this._searchText="",this._selectedCompetencies=[]},i.prototype.setDisallowedCompetencyIDs=function(a){this._disallowedCompetencyIDs=a},i.prototype._trigger=function(a,b){this._eventNode.trigger(a,[b])},i});