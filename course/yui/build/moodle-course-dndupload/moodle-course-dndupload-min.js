YUI.add("moodle-course-dndupload",function(e,t){e.namespace("Moodle.course.dndupload");var n={sections:"li.section.main",section_mod:"ul.section",sections_mods:"li.section.main ul.section",section_types:"li.section, li.main",preview_element:".dndupload-preview",dnduploader:".dndupload-loaded",progressbar:".dndupload-progress-outer"},r={dnduploader:"dndupload-loaded",preview_hide:"dndupload-hidden",preview_over:"dndupload-over"},i="moodle-course-dndupload",s;s=function(){s.superclass.constructor.apply(this,arguments)},e.extend(s,e.Base,{uploadQueue:new e.AsyncQueue,currentSection:null,lastSection:null,enterCount:0,previews_established:!1,initializer:function(){if(e.one(e.config.doc.body).hasClass(n.dnduploader))return;e.one(e.config.doc.body).addClass(r.dnduploader);if(!e.Moodle.course.dnduploadloader.browser_supported())return;if(!e.one(n.sections))return;e.delegate("dragenter",this.dragenter,e.config.doc,n.sections,this),e.delegate("dragleave",this.dragleave,e.config.doc,n.sections,this),e.delegate("dragover",this.dragover,e.config.doc,n.sections,this),e.delegate("drop",this.drop,e.config.doc,n.sections,this),this.get("showStatusMessage")&&this.add_status_div()},add_status_div:function(){},add_preview_to_section:function(t){if(this.previews_established)return;return typeof this.previewnode=="undefined"&&(this.previewnode=e.Node.create('<li class="dndupload-preview dndupload-hidden"><div class="mod-indent"><img src="'+M.util.image_url("t/addfile")+'"/>'+'<span class="instancename" />'+"</div>"+"</li>"),this.previewnode.one("span").set("innerHTML",M.util.get_string("addfilehere","core"))),t.one("ul.section").append(this.previewnode),this.previewnode},setup_section_previews:function(){if(this.previews_established)return;var t=e.Node.create('<li class="dndupload-preview dndupload-hidden"><div class="mod-indent"><img src="'+M.util.image_url("t/addfile")+'"/>'+'<span class="instancename" />'+"</div>"+"</li>");t.one("span").set("innerHTML",M.util.get_string("addfilehere","core")),e.all(n.sections_mods).each(function(e){e.appendChild(t.cloneNode(!0))}),this.previews_established=!0},setup_section_mod_elements:function(){var t=e.all(n.sections),r=e.Node.create('<ul class="section img-text"></ul>');t.each(function(){if(this.one(n.section_mod))return;this.appendChild(r.cloneNode(!0))})},types_includes:function(e,t){var n;for(n in e._event.dataTransfer.types){if(!e._event.dataTransfer.types.hasOwnProperty(n))continue;if(e._event.dataTransfer.types[n]===t)return!0}return!1},dragtype:function(e){if(e._event.dataTransfer===null)return!1;if(e._event.dataTransfer.types===null)return!1;if(e._event.dataTransfer.types.length===0)return!1;if(this.types_includes(e,"Files"))if(e.type!=="drop"||e._event.dataTransfer.files.length!==0)return this.get("handlers").filehandlers.length===0?!1:{realtype:"Files",addmessage:M.util.get_string("addfilehere","core"),namemessage:null,type:"Files"};var t;for(t in this.get("handlers").types){if(!this.get("handlers").types.hasOwnProperty(t))continue;var n=this.get("handlers").types[t].datatransfertypes,r;for(r in n){if(!n.hasOwnProperty(r))continue;if(this.types_includes(e,n[r]))return{realtype:n[r],addmessage:this.get("handlers").types[t].addmessage,namemessage:this.get("handlers").types[t].namemessage,handlermessage:this.get("handlers").types[t].handlermessage,type:this.get("handlers").types[t].identifier,handlers:this.get("handlers").types[t].handlers}}}return!1},check_drag:function(e){var t=this.dragtype(e);return t&&(e.stopPropagation(),e.preventDefault()),t},get_section:function(e){return e.ancestor(n.section_types,!0)},get_section_id:function(e){return e.get("id").replace("section-","")},hideDropTarget:function(e){e=e||this.currentSection,e&&e.getMask().hide()},showDropTarget:function(e,t){var n=e.getMask();n.one(".mask-content").set("innerHTML",t.addmessage),n.show()},dragenter:function(e){var t=this.check_drag(e),r=e.currentTarget.ancestor(n.section_types,!0);if(!t)return;if(!r)return;r!==this.currentSection?(this.currentSection=r,this.enterCount=1,this.showDropTarget(r,t)):this.enterCount=2},dragleave:function(e){if(!this.check_drag(e))return;var t=e.currentTarget.ancestor(n.section_types,!0);if(!t)return;if(t!==this.currentSection){this.hideDropTarget(t),this.enterCount=1;return}this.enterCount<=1?(this.enterCount=0,this.hideDropTarget(t)):this.enterCount=1},dragover:function(e){this.check_drag(e)},drop:function(e){var t=this.check_drag(e),n=this.get_section(e.currentTarget);if(!t)return this.hideDropTarget(),!1;if(!n)return this.hideDropTarget(),!1;var r,i,s;if(t.type==="Files"){r=e._event.dataTransfer.files;for(s=0;s<r.length;s++){if(!r.hasOwnProperty(s))continue;this.uploadQueue.add({fn:this.handle_file,context:this,args:[r[s],n],timeout:-1})}}else i=e._event.dataTransfer.getData(t.realtype),i&&this.uploadQueue.add({fn:this.handle_item,context:this,args:[t,i,n]});this.uploadQueue.run()},handle_file:function(e,t){var n=[],r=null,i=null,s=this.get("handlers").filehandlers,o="",u=e.name.lastIndexOf(".");u!==-1&&(o=e.name.substr(u+1,e.name.length).toLowerCase());for(r in s){if(!s.hasOwnProperty(r))continue;i=s[r],(i.extension==="*"||i.extension===o)&&n.push(i)}if(n.length===0)return;return n.length===1?this.upload_file(e,t,n[0].module):this.file_handler_dialog(e,t,n,o)},upload_file:function(t,n,r){this.hideDropTarget(n);if(t.size>this.get("maxbytes"))return new M.core.alert({title:M.util.get_string("fileuploaderror","core"),message:M.util.get_string("filetoolarge","core",t.name)});var i=this.addProgressBar(t.name,n,r),s=i.one(".dndupload-progress-inner"),o=new e.File({file:t});return o.on("uploadprogress",function(e){s.setStyle("width",e.percentLoaded+"%")}),o.on("uploadcomplete",this.handleUploadResponse,this,i),o.startUpload(this.get("uploadURL"),{sesskey:M.cfg.sesskey,course:this.get("courseid"),section:this.get_section_id(n),module:r,type:"Files"},"repo_upload_file"),o},handleUploadResponse:function(t,n){try{responseobject=e.JSON.parse(t.data);if(responseobject.error
)return n.remove(!0),new M.core.ajaxException(responseobject)}catch(r){return n.remove(!0),new M.core.exception(r)}var i=e.Node.create(responseobject.fullcontent);n.replace(i),this.add_editing(responseobject.cmid);return},check_upload_queue:function(){this.uploaddialog=!1;if(this.uploadqueue.length===0)return;var e=this.uploadqueue.shift();if(e.isfile)return this.file_handler_dialog(e.file,e.section,e.handlers,e.extension);this.handle_item(e.type,e.contents,e.section,e.sectionnumber)},file_handler_dialog:function(t,n,r){this.uploaddialog||(this.uploaddialog=new M.core.dialogue({visible:!1,render:!1,centered:!0,modal:!0,draggable:!0}),this.uploaddialog.uploadbutton=this.uploaddialog.addButton({label:M.util.get_string("upload","core"),context:this,action:"process_uploaddialog",isDefault:!0}),this.uploaddialog.closebutton=this.uploaddialog.addButton({label:M.util.get_string("cancel","core"),context:this.uploaddialog,action:function(){this.hide()}}),this.uploaddialog.render().hide()),this.uploaddialog.file=t,this.uploaddialog.section=n;var i,s=e.Node.create('<div class="option"><label><input type="radio" name="handler" /><span class="modicon"><img class="icon" /></span><span class="typename" /></label></div>'),o=e.Node.create("<div><p /></div>"),u=null,a=null;o.one("p").set("innerHTML",M.util.get_string("actionchoice","core",t.name));for(i=0;i<r.length;i++)a=r[i],u=s.cloneNode(!0),u.one("img").setAttribute("src",M.util.image_url("icon","mod_"+a.module)),u.one("input").setAttribute("value",a.module),u.one("span.typename").set("innerHTML",a.message),o.appendChild(u);this.uploaddialog.options=o,this.uploaddialog.set("bodyContent",o),this.uploaddialog.show(),o.one("input[type=radio]").focus();return},process_uploaddialog:function(){var e=null;this.uploaddialog.get("boundingBox").all("input").each(function(t){t.get("checked")&&(e=t.get("value"))},this);if(e===null)return;this.uploaddialog.hide(),this.upload_file(this.uploaddialog.file,this.uploaddialog.section,e)},addProgressBar:function(t,n){var r=e.Node.create('<li class="activity"><div class="mod-indent"><div class="activityinstance"><a href="#"><img src="'+M.util.image_url("i/ajaxloader")+'" class="activityicon iconlarge" />'+'<span class="instancename" />'+"</a>"+'<span class="groupinglabel" />'+'<span class="dndupload-progress-outer" >'+'<span class="dndupload-progress-inner">&nbsp;</span>'+"</span>"+"</div>"+"</div>"+"</li>"),i=r.one(".instancename"),s=this.getSectionModuleList(n);return i.set("innerHTML",t),s.appendChild(r),r},getSectionModuleList:function(e){var t=e.one(n.section_mod);return t},add_editing:function(e){M.course.coursebase.invoke_function("setup_for_resource","#module-"+e)},handle_item:function(t,n,r){if(t.handlers.length===0)return;if(t.handlers.length===1&&t.handlers[0].noname){this.upload_item("",t.type,n,r,sectionnumber,t.handlers[0].module),this.check_upload_queue();return}if(this.uploaddialog){var i={isfile:!1,type:t,contents:n,section:r};return this.uploadqueue.push(i)}this.uploaddialog=!0;var s=(new Date).getTime(),o=Math.round(Math.random()*1e5)+"-"+s,u="dndupload_handler_name"+o,a="";if(t.handlers.length>1){a+="<p>"+t.handlermessage+"</p>",a+='<div id="dndupload_handlers'+o+'">';var f=t.handlers[0].module;for(var l=0;l<t.handlers.length;l++){var c="dndupload_handler"+o+t.handlers[l].module,h=t.handlers[l].module===f?'checked="checked" ':"";a+='<input type="radio" name="handler" value="'+l+'" id="'+c+'" '+h+"/>",a+=' <label for="'+c+'">',a+=t.handlers[l].message,a+="</label><br/>"}a+="</div>"}var p=t.handlers[0].noname?' disabled = "disabled" ':"";a+='<label for="'+u+'">'+t.namemessage+"</label>",a+=' <input type="text" id="'+u+'" value="" '+p+" />";var d=this,v=new M.core.dialogue({bodyContent:a,width:"350px",modal:!0,visible:!0,render:!0,align:{node:null,points:[e.WidgetPositionAlign.CC,e.WidgetPositionAlign.CC]}});v.after("visibleChange",function(){this.hideDropTarget(r),v.get("visible")||(v.destroy(!0),d.check_upload_queue())},this);var m=e.one("#"+u),g=function(i){i.preventDefault();var s=e.Lang.trim(m.get("value")),u=!1,a=!1;if(t.handlers.length>1){var f=e.one("#dndupload_handlers"+o);f.all("input").each(function(e){if(e.get("checked")){var n=e.get("value");u=t.handlers[n].module,a=t.handlers[n].noname}});if(!u)return}else u=t.handlers[0].module,a=t.handlers[0].noname;if(s===""&&!a)return;a&&(s=""),v.hide(),d.upload_item(s,t.type,n,r,sectionnumber,u)};v.addButton({label:M.util.get_string("upload","core"),action:g,section:e.WidgetStdMod.FOOTER,name:"submit",isDefault:!0}),v.addButton({label:M.util.get_string("cancel","core"),action:function(e){e.preventDefault(),v.hide()},section:e.WidgetStdMod.FOOTER});var y=v.getButton("submit").button;m.on("key",g,"enter"),m.after("keyup",function(){e.Lang.trim(m.get("value"))===""?y.disable():y.enable()});var b;for(b=0;b<t.handlers.length;b++)t.handlers[b].noname?e.one("#dndupload_handler"+o+t.handlers[b].module).on("click",function(){m.set("disabled","disabled"),y.enable()}):e.one("#dndupload_handler"+o+t.handlers[b].module).on("click",function(){m.removeAttribute("disabled"),m.focus(),e.Lang.trim(m.get("value"))===""&&y.disable()});e.one("#"+u).focus()},upload_item:function(e,t,n,i,s){var o=new XMLHttpRequest,u=this,a=this.addProgressBar(e,i,s);a.removeClass(r.preview_hide),o.onreadystatechange=function(){if(o.readyState===4)if(o.status===200){var e=JSON.parse(o.responseText);e&&(e.error===0?(e.content?a.indentdiv.innerHTML='<div class="activityinstance" ></div>'+e.content+e.commands:(a.icon.src=e.icon,a.a.href=e.link,a.namespan.innerHTML=e.name,parseInt(e.visible,10)||(a.a.className="dimmed"),e.groupingname?a.groupingspan.innerHTML="("+e.groupingname+")":a.div.removeChild(a.groupingspan),a.div.removeChild(a.progressouter),a.div.innerHTML+=e.commands,e.onclick&&(a.a.onclick=e.onclick),u.Y.UA.gecko>0&&(a.div.innerHTML=unescape(a.div.innerHTML))),a.li.id=e.elementid,u.add_editing(e.elementid,sectionnumber)):(a.parent.removeChild(a.li),alert(e.error)))}else alert(M.util.get_string
("servererror","core"))};var f=new FormData;f.append("contents",n),f.append("displayname",e),f.append("sesskey",M.cfg.sesskey),f.append("course",this.get("courseid")),f.append("section",sectionnumber),f.append("type",t),f.append("module",s),o.open("POST",this.get("uploadURL"),!0),o.send(f)}},{ATTRS:{maxbytes:{value:null},courseid:{value:null},handlers:{value:[]},showStatusMessage:{value:!0},statusMessage:{value:{identifier:"dndstatus",component:"moodle"},getter:function(e){return M.util.get_string(e.identifier,e.component)}},uploadURL:{value:M.cfg.wwwroot+"/course/dndupload.php"}}}),e.Moodle.course.dndupload.init=function(e){return new s(e)}},"@VERSION@",{requires:["moodle-course-dndupload-loader","node","event","json","anim","dd","moodle-core-notification","moodle-course-coursebase","selector-css3","file","moodle-core-util-mask","promise","async-queue"]});
