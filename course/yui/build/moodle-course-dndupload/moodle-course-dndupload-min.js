YUI.add("moodle-course-dndupload",function(e,t){e.namespace("Moodle.course.dndupload");var n={sections:"li.section.main",section_mod:"ul.section",sections_mods:"li.section.main ul.section",section_types:"li.section, li.main",preview_element:".dndupload-preview"},r={preview_hide:"dndupload-hidden",preview_over:"dndupload-over"};e.Moodle.course.dndupload={maxbytes:null,courseid:null,handlers:null,uploadqueue:[],lastselected:[],showstatus:!1,previews_established:!1,currentsection:null,entercount:0,init:function(t){if(!this.browser_supported())return;if(!e.one(n.sections))return;this.maxbytes=t.maxbytes,this.courseid=t.courseid,this.handlers=t.handlers,e.delegate("dragenter",this.dragenter,e.config.doc,n.sections,this),e.delegate("dragleave",this.dragleave,e.config.doc,n.sections,this),e.delegate("dragover",this.dragover,e.config.doc,n.sections,this),e.delegate("drop",this.drop,e.config.doc,n.sections,this),this.showstatus&&this.add_status_div()},browser_supported:function(){return typeof FileReader=="undefined"?!1:typeof FormData=="undefined"?!1:!0},setup_section_previews:function(){if(this.previews_established)return;var t=e.Node.create('<li class="dndupload-preview dndupload-hidden"><div class="mod-indent"><img /> <span class="instancename" /></div></li>');t.one("img").set("src",M.util.image_url("t/addfile")),t.one("span").set("innerHTML",M.util.get_string("addfilehere","moodle")),e.all(n.sections_mods).each(function(e){e.appendChild(t.cloneNode(!0))}),this.previews_established=!0},setup_section_mod_elements:function(){var t=e.all(n.sections),r=e.Node.create('<ul class="section img-text"></ul>');t.each(function(){if(this.one(n.section_mod))return;this.appendChild(r.cloneNode(!0))})},types_includes:function(e,t){var n;for(n in e._event.dataTransfer.types){if(!e._event.dataTransfer.types.hasOwnProperty(n))continue;if(e._event.dataTransfer.types[n]===t)return!0}return!1},dragtype:function(e){if(e._event.dataTransfer===null)return!1;if(e._event.dataTransfer.types===null)return!1;if(e._event.dataTransfer.types.length===0)return!1;if(this.types_includes(e,"Files"))if(e.type!=="drop"||e._event.dataTransfer.files.length!==0)return this.handlers.filehandlers.length===0?!1:{realtype:"Files",addmessage:"addfilehere",namemessage:null,type:"Files"};var t;for(t in this.handlers.types){if(!this.handlers.types.hasOwnProperty(t))continue;var n=this.handlers.types[t].datatransfertypes,r;for(r in n){if(!n.hasOwnProperty(r))continue;if(this.types_includes(e,n[r]))return{realtype:n[r],addmessage:this.handlers.types[t].addmessage,namemessage:this.handlers.types[t].namemessage,handlermessage:this.handlers.types[t].handlermessage,type:this.handlers.types[t].identifier,handlers:this.handlers.types[t].handlers}}}return!1},check_drag:function(e){var t=this.dragtype(e);return t&&(e.stopPropagation(),e.preventDefault()),t},get_section:function(e){return e.ancestor(n.section_types,!0)},get_section_id:function(e){return e.get("id").replace("section-","")},hide_preview_element:function(){this.currentsection&&this.currentsection.addClass(r.preview_hide).removeClass(r.preview_over)},show_preview_element:function(e,t){this.hide_preview_element();if(e){this.currentsection=e,this.currentsection.removeClass(r.preview_hide).addClass(r.preview_over);var n=this.currentsection.one("span").getDOMNode();n.firstChild.nodeValue=t.addmessage}},dragenter:function(e){this.setup_section_previews();var t=this.check_drag(e),r=e.currentTarget.ancestor(n.section_types,!0);return t?r?(r=r.one(n.preview_element),this.currentsection!==r?(this.entercount=1,this.show_preview_element(r,t),!0):(this.entercount++,this.entercount>2?(this.entercount=2,!1):!1)):!1:!1},dragleave:function(e){return this.check_drag(e)?(this.entercount--,this.entercount>=0?!1:(this.entercount=0,this.hide_preview_element(),this.currentsection=null,!0)):!1},dragover:function(e){this.check_drag(e)},drop:function(e){var t=this.check_drag(e),n=this.get_section(e.currentTarget);if(!t)return!1;if(!n)return!1;this.hide_preview_element();var r=this.get_section_id(n),i,s,o;if(t.type==="Files"){i=e._event.dataTransfer.files;for(o in i){if(!i.hasOwnProperty(o))continue;this.handle_file(i[o],n,r)}}else s=e._event.dataTransfer.getData(t.realtype),s&&this.handle_item(t,s,n,r)},handle_file:function(e,t,n){var r=[],i=null,s=null,o=this.handlers.filehandlers,u="",a=e.name.lastIndexOf(".");a!==-1&&(u=e.name.substr(a+1,e.name.length).toLowerCase());for(i in o){if(!o.hasOwnProperty(i))continue;s=o[i],(s.extension==="*"||s.extension===u)&&r.push(s)}if(r.length===0)return;return r.length===1?this.upload_file(e,t,n,r[0].module):this.file_handler_dialog(e,t,n,r,u)},upload_file:function(e,t,n,r){var i=new XMLHttpRequest,s=this;if(e.size>this.maxbytes){alert("'"+e.name+"' "+M.util.get_string("filetoolarge","moodle"));return}var o=this.add_resource_element(e.name,t,r);i.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=Math.round(e.loaded*100/e.total);o.progress.style.width=t+"%"}},!1),i.onreadystatechange=function(){if(i.readyState===4)if(i.status===200){var e=JSON.parse(i.responseText);e&&(e.error===0?(e.content?o.indentdiv.innerHTML='<div class="activityinstance" ></div>'+e.content+e.commands:(o.icon.src=e.icon,o.a.href=e.link,o.namespan.innerHTML=e.name,parseInt(e.visible,10)||(o.a.className="dimmed"),e.groupingname?o.groupingspan.innerHTML="("+e.groupingname+")":o.div.removeChild(o.groupingspan),o.div.removeChild(o.progressouter),o.indentdiv.innerHTML+=e.commands,e.onclick&&(o.a.onclick=e.onclick),s.Y.UA.gecko>0&&(o.div.innerHTML=unescape(o.div.innerHTML))),o.li.id=e.elementid,s.add_editing(e.elementid)):(o.parent.removeChild(o.li),alert(e.error)))}else alert(M.util.get_string("servererror","moodle"))};var u=new FormData;u.append("repo_upload_file",e),u.append("sesskey",M.cfg.sesskey),u.append("course",this.courseid),u.append("section",n),u.append("module",r),u.append("type","Files"),i.open("POST",this.url,!0),i.send(u)},add_editing:function(t){e.use("moodle-course-coursebase"
,function(){this.add_editing=this._add_editing,this.add_editing(t)})},_add_editing:function(e){M.course.coursebase.invoke_function("setup_for_resource","#"+e)}}},"@VERSION@",{requires:["node","event","json","anim","dd","moodle-core-notification","selector-css3"]});
