YUI.add("moodle-course-dndupload",function(e,t){e.namespace("Moodle.course.dndupload");var n={couremodule:"li.activity",sections:"li.section.main",section_mod:"ul.section",section_types:"li.section, li.main",dnduploader:".dndupload-loaded"},r={dnduploader:"dndupload-loaded",preview_hide:"dndupload-hidden",preview_over:"dndupload-over"},i="moodle-course-dndupload",s;s=function(){s.superclass.constructor.apply(this,arguments)},e.extend(s,e.Base,{processQueue:new e.AsyncQueue,dialogueQueue:new e.AsyncQueue,currentSection:null,enterCount:0,delayDialogues:!0,initializer:function(){if(e.one(e.config.doc.body).hasClass(n.dnduploader))return;e.one(e.config.doc.body).addClass(r.dnduploader);if(!e.Moodle.course.dnduploadloader.browser_supported())return;if(!e.one(n.sections))return;e.delegate("dragenter",this.dragenter,e.config.doc,n.sections,this),e.delegate("dragleave",this.dragleave,e.config.doc,n.sections,this),e.delegate("dragover",this.dragover,e.config.doc,n.sections,this),e.delegate("drop",this.drop,e.config.doc,n.sections,this),this.get("showStatusMessage")&&this.addStatusMessage()},addStatusMessage:function(){return this},isUploadTypeValid:function(e,t){var n;for(n in e._event.dataTransfer.types){if(!e._event.dataTransfer.types.hasOwnProperty(n))continue;if(e._event.dataTransfer.types[n]===t)return!0}return!1},dragtype:function(e){if(e._event.dataTransfer===null)return!1;if(e._event.dataTransfer.types===null)return!1;if(e._event.dataTransfer.types.length===0)return!1;if(this.isUploadTypeValid(e,"Files"))if(e.type!=="drop"||e._event.dataTransfer.files.length!==0)return this.get("handlers").filehandlers.length===0?!1:{realtype:"Files",addmessage:M.util.get_string("addfilehere","core"),namemessage:null,type:"Files"};var t=this.get("handlers").types,n;for(n in t){if(!t.hasOwnProperty(n))continue;var r=t[n].datatransfertypes,i;for(i in r){if(!r.hasOwnProperty(i))continue;if(this.isUploadTypeValid(e,r[i]))return{realtype:r[i],addmessage:t[n].addmessage,namemessage:t[n].namemessage,handlermessage:t[n].handlermessage,type:t[n].identifier,handlers:t[n].handlers}}}return!1},checkDrag:function(e){var t=this.dragtype(e);return t&&(e.stopPropagation(),e.preventDefault()),t},get_section:function(e){return e.ancestor(n.section_types,!0)},get_section_id:function(e){return e.get("id").replace("section-","")},hideDropTarget:function(e){return e=e||this.currentSection,e&&e.getMask().hide(),this},showDropTarget:function(e,t){var n=e.getMask();return n.one(".mask-content").set("innerHTML",t.addmessage),n.show(),this},dragenter:function(e){var t=this.checkDrag(e),r=e.currentTarget.ancestor(n.section_types,!0);if(!t)return;if(!r)return;r!==this.currentSection||this.enterCount===0?(this.currentSection=r,this.enterCount=1,this.showDropTarget(r,t)):this.enterCount=2},dragleave:function(e){if(!this.checkDrag(e))return;var t=e.currentTarget.ancestor(n.section_types,!0);if(!t)return;if(t!==this.currentSection){this.hideDropTarget(t),this.enterCount=1;return}this.enterCount<=1?(this.enterCount=0,this.hideDropTarget(t)):this.enterCount=1},dragover:function(e){this.checkDrag(e)},drop:function(e){var t=this.checkDrag(e),n=this.get_section(e.currentTarget);this.enterCount=0,this.hideDropTarget(n);if(!t)return this.hideDropTarget(),!1;if(!n)return this.hideDropTarget(),!1;var r,i,s;if(t.type==="Files"){r=e._event.dataTransfer.files;for(s=0;s<r.length;s++){if(!r.hasOwnProperty(s))continue;this.processQueue.add({fn:this.handleFile,context:this,args:[r[s],n]})}}else i=e._event.dataTransfer.getData(t.realtype),i&&this.processQueue.add({fn:this.handle_item,context:this,args:[t,i,n]});this.processQueue.add({fn:this.dialogueQueue.run,context:this.dialogueQueue}),this.processQueue.run()},handleFile:function(e,t){var n=[],r=null,i=null,s=this.get("handlers").filehandlers,o="",u=e.name.lastIndexOf(".");u!==-1&&(o=e.name.substr(u+1,e.name.length).toLowerCase());for(r in s){if(!s.hasOwnProperty(r))continue;i=s[r],(i.extension==="*"||i.extension===o)&&n.push(i)}if(n.length===0){this.hideDropTarget();return}return n.length===1?(this.hideDropTarget(),this.uploadFile(e,t,n[0].module)):(this.dialogueQueue.add({fn:this.queryFileType,context:this,args:[e,t,n]}),this)},uploadFile:function(t,r,i){this.hideDropTarget(r),this.processQueue.isRunning()||this.processQueue.run();if(t.size>this.get("maxbytes"))return e.use("moodle-core-notification-alert",function(){return new M.core.alert({title:M.util.get_string("fileuploaderror","core"),message:M.util.get_string("filetoolarge","core",t.name)})});var s=this.addProgressBar(t.name,r),o=s.one(".dndupload-progress-inner"),u=e.one(s),a=0;do a++,u=u.previous(n.coursemodule);while(u);var f={sesskey:M.cfg.sesskey,course:this.get("courseid"),section:this.get_section_id(r),module:i,type:"Files",position:a},l=new e.File({file:t});return l.on("uploadprogress",function(e){o.setStyle("width",e.percentLoaded+"%")}),l.on("uploadcomplete",this.handleUploadResponse,this,s),l.startUpload(this.get("uploadURL"),f,"repo_upload_file"),l},handleUploadResponse:function(t,n){try{var r=t.data||t.response;responseobject=e.JSON.parse(r);if(responseobject.error)return n.remove(!0),e.use("moodle-core-notification-ajaxexception",function(){new M.core.ajaxException(responseobject)})}catch(i){return n.remove(!0),e.use("moodle-core-notification-exception",function(){new M.core.exception(i)})}var s=e.Node.create(responseobject.fullcontent);n.replace(s),this.setupJSForCourseModule(responseobject.cmid);return},queryFileType:function(t,n,r){this.dialogueQueue.pause();var i=this.getDialogue(),s,o;o={filemessage:M.util.get_string("filemessage","course",t),items:[]},e.Array.each(r,function(e){o.items.push({modname:e.module,icon:M.util.image_url("icon","mod_"+e.module),message:e.message})}),s=this.getDialogueTemplate(o),i.set("bodyContent",s);var u=i.getButton("upload").on("click",function(){var e=i.bodyNode.one('input[name="handler"]:checked');e&&(this.processQueue.add({fn:this.uploadFile,context:this,args:[t,n,e.get("value")]}),i.hide())}
,this);i.eventListeners.push(u),i.show()},getDialogue:function(){return this.uploadDialog||(this.uploadDialog=new M.core.dialogue({visible:!1,centered:!0,modal:!0,draggable:!0}),this.uploadDialog.addButton({name:"upload",label:M.util.get_string("upload","core"),isDefault:!0}),this.uploadDialog.addButton({name:"cancel",label:M.util.get_string("cancel","core"),action:function(){this.hide()}}),this.uploadDialog.on("visibleChange",function(t){t.prevVal&&!t.newVal&&((new e.EventHandle(this.uploadDialog.eventListeners)).detach(),this.uploadDialog.eventListeners=null,this.processQueue.run(),this.dialogueQueue.run())},this)),this.uploadDialog.eventListeners=[],this.uploadDialog},getDialogueTemplate:function(t){return this.bodyContent||(this.bodyContent=e.Handlebars.compile("<div class='option'>{{#items}}<label><input type='radio' name='handler' value={{modname}}><span class='modicon'><img class='icon' src={{icon}}></span><span class='typename'>{{message}}</span></label>{{/items}}</div>")),this.bodyContent(t)},addProgressBar:function(t,n){var r=e.Node.create('<li class="activity"><div class="mod-indent"><div class="activityinstance"><a href="#"><img src="'+M.util.image_url("i/ajaxloader")+'" class="activityicon iconlarge" />'+'<span class="instancename" />'+"</a>"+'<span class="groupinglabel" />'+'<span class="dndupload-progress-outer" >'+'<span class="dndupload-progress-inner">&nbsp;</span>'+"</span>"+"</div>"+"</div>"+"</li>"),i=r.one(".instancename"),s=this.getSectionModuleList(n);return i.set("innerHTML",t),s.appendChild(r),r},getSectionModuleList:function(e){var t=e.one(n.section_mod);return t},setupJSForCourseModule:function(t){M.course.coursebase.invoke_function("setup_for_resource","#module-"+t);var n=e.one("#module-"+t);n&&M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(n)},handle_item:function(t,n,r){if(t.handlers.length===0)return;var i=this.addProgressBar("",r);if(t.handlers.length===1&&t.handlers[0].noname){this.hideDropTarget(),this.uploadItem("",t.type,n,r,t.handlers[0].module,i);return}this.uploaddialog=!0;var s=(new Date).getTime(),o=Math.round(Math.random()*1e5)+"-"+s,u="dndupload_handler_name"+o,a="";if(t.handlers.length>1){a+="<p>"+t.handlermessage+"</p>",a+='<div id="dndupload_handlers'+o+'">';var f=t.handlers[0].module;for(var l=0;l<t.handlers.length;l++){var c="dndupload_handler"+o+t.handlers[l].module,h=t.handlers[l].module===f?'checked="checked" ':"";a+='<input type="radio" name="handler" value="'+l+'" id="'+c+'" '+h+"/>",a+=' <label for="'+c+'">',a+=t.handlers[l].message,a+="</label><br/>"}a+="</div>"}var p=t.handlers[0].noname?' disabled = "disabled" ':"";a+='<label for="'+u+'">'+t.namemessage+"</label>",a+=' <input type="text" id="'+u+'" value="" '+p+" />";var d=this,v=new M.core.dialogue({bodyContent:a,width:"350px",modal:!0,visible:!0,render:!0,align:{node:null,points:[e.WidgetPositionAlign.CC,e.WidgetPositionAlign.CC]}});v.after("visibleChange",function(){this.hideDropTarget(r),v.get("visible")||v.destroy(!0)},this);var m=e.one("#"+u),g=function(s){s.preventDefault();var u=e.Lang.trim(m.get("value")),a=!1,f=!1;if(t.handlers.length>1){var l=e.one("#dndupload_handlers"+o);l.all("input").each(function(e){if(e.get("checked")){var n=e.get("value");a=t.handlers[n].module,f=t.handlers[n].noname}});if(!a)return}else a=t.handlers[0].module,f=t.handlers[0].noname;if(u===""&&!f)return;f&&(u=""),v.hide(),d.uploadItem(u,t.type,n,r,a,i)};v.addButton({label:M.util.get_string("upload","core"),action:g,section:e.WidgetStdMod.FOOTER,name:"submit",isDefault:!0}),v.addButton({label:M.util.get_string("cancel","core"),action:function(e){e.preventDefault(),v.hide(),this.processQueue.run()},section:e.WidgetStdMod.FOOTER});var y=v.getButton("submit").button;m.on("key",g,"enter"),m.after("keyup",function(){e.Lang.trim(m.get("value"))===""?y.disable():y.enable()});var b;for(b=0;b<t.handlers.length;b++)t.handlers[b].noname?e.one("#dndupload_handler"+o+t.handlers[b].module).on("click",function(){m.set("disabled","disabled"),y.enable()}):e.one("#dndupload_handler"+o+t.handlers[b].module).on("click",function(){m.removeAttribute("disabled"),m.focus(),e.Lang.trim(m.get("value"))===""&&y.disable()});e.one("#"+u).focus()},uploadItem:function(t,n,r,i,s,o){this.hideDropTarget(i),this.processQueue.isRunning()||this.processQueue.run(),o||(o=this.addProgressBar(file.name,i));var u=o.one(".dndupload-progress-inner"),a={data:{sesskey:M.cfg.sesskey,course:this.get("courseid"),section:this.get_section_id(i),module:s,type:n,contents:r,displayname:t},on:{complete:function(e,t){this.handleUploadResponse(t,o)},progress:function(e,t){u.setStyle("width",t.percentLoaded+"%")}},context:this};e.io(this.get("uploadURL"),a)}},{ATTRS:{maxbytes:{value:null},courseid:{value:null},handlers:{value:[]},showStatusMessage:{value:!0},statusMessage:{value:{identifier:"dndstatus",component:"moodle"},getter:function(e){return M.util.get_string(e.identifier,e.component)}},uploadURL:{value:M.cfg.wwwroot+"/course/dndupload.php"}}}),e.Moodle.course.dndupload.init=function(e){return new s(e)}},"@VERSION@",{requires:["moodle-course-dndupload-loader","node","event","json","anim","dd","moodle-core-notification","moodle-course-coursebase","selector-css3","file","moodle-core-util-mask","promise","async-queue","handlebars"]});
