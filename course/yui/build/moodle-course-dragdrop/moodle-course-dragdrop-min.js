YUI.add("moodle-course-dragdrop",function(e,t){var n={ACTIVITY:"activity",COMMANDSPAN:"span.commands",CONTENT:"content",COURSECONTENT:"course-content",EDITINGMOVE:"editing_move",ICONCLASS:"iconsmall",JUMPMENU:"jumpmenu",LEFT:"left",LIGHTBOX:"lightbox",MOVEDOWN:"movedown",MOVEUP:"moveup",PAGECONTENT:"page-content",RIGHT:"right",SECTION:"section",SECTIONADDMENUS:"section_add_menus",SECTIONHANDLE:"section-handle",SUMMARY:"summary"},r=function(){r.superclass.constructor.apply(this,arguments)};e.extend(r,M.core.dragdrop,{sectionlistselector:null,initializer:function(t){this.groups=["section"],this.samenodeclass=M.course.format.get_sectionwrapperclass(),this.parentnodeclass=M.course.format.get_containerclass();if(e.Node.one("."+n.JUMPMENU))return!1;this.sectionlistselector=M.course.format.get_section_wrapper(e);if(this.sectionlistselector){this.sectionlistselector="."+n.COURSECONTENT+" "+this.sectionlistselector,this.setup_for_section(this.sectionlistselector);var r=this.sectionlistselector.slice(n.COURSECONTENT.length+2),i=new e.DD.Delegate({container:"."+n.COURSECONTENT,nodes:r,target:!0,handles:["."+n.LEFT],dragConfig:{groups:this.groups}});i.dd.plug(e.Plugin.DDProxy,{moveOnEnd:!1}),i.dd.plug(e.Plugin.DDConstrained,{constrain:"#"+n.PAGECONTENT,stickY:!0}),i.dd.plug(e.Plugin.DDWinScroll)}},setup_for_section:function(t){e.Node.all(t).each(function(e){var t=this.get_section_id(e);if(t>0){var r=e.one("."+n.RIGHT+" a."+n.MOVEDOWN),i=e.one("."+n.RIGHT+" a."+n.MOVEUP),s=M.util.get_string("movesection","moodle",t),o=e.one("."+n.LEFT);(r||i)&&o&&(o.setStyle("cursor","move"),o.appendChild(this.get_drag_handle(s,n.SECTIONHANDLE,"icon",!0)),i&&i.remove(),r&&r.remove())}},this)},get_section_id:function(e){return Number(e.get("id").replace(/section-/i,""))},drag_start:function(t){var r=t.target,i=e.Node.create("<"+M.course.format.get_containernode()+"></"+M.course.format.get_containernode()+">");i.addClass(M.course.format.get_containerclass());var s=e.Node.create("<"+M.course.format.get_sectionwrappernode()+"></"+M.course.format.get_sectionwrappernode()+">");s.addClass(M.course.format.get_sectionwrapperclass()),s.setStyle("margin",0),s.setContent(r.get("node").get("innerHTML")),i.appendChild(s),r.get("dragNode").setContent(i),r.get("dragNode").addClass(n.COURSECONTENT)},drag_dropmiss:function(e){this.drop_hit(e)},drop_hit:function(t){var r=t.drag,i=r.get("node"),s=t.drop.get("node"),o=Number(this.get_section_id(i)),u=Number(this.get_section_id(s)),a=o,f=u;this.goingup&&(a=u,f=o),r.get("dragNode").removeClass(n.COURSECONTENT);var l=e.Node.all(this.sectionlistselector),c=M.util.add_lightbox(e,i),h={},p=this.get("config").pageparams;for(varname in p)h[varname]=p[varname];h.sesskey=M.cfg.sesskey,h.courseId=this.get("courseid"),h["class"]="section",h.field="move",h.id=o,h.value=u;var d=M.cfg.wwwroot+this.get("ajaxurl");e.io(d,{method:"POST",data:h,on:{start:function(e){c.show()},success:function(t,n){try{var r=e.JSON.parse(n.responseText);r.error&&new M.core.ajaxException(r),M.course.format.process_sections(e,l,r,a,f)}catch(i){}do{var s=!1;for(var o=a;o<=f;o++)if(this.get_section_id(l.item(o-1))>this.get_section_id(l.item(o))){var u=l.item(o-1).get("id");l.item(o-1).set("id",l.item(o).get("id")),l.item(o).set("id",u),M.course.format.swap_sections(e,o-1,o),s=!0}f-=1}while(s);window.setTimeout(function(e){c.hide()},250)},failure:function(e,t){this.ajax_failure(t),c.hide()}},context:this})}},{NAME:"course-dragdrop-section",ATTRS:{courseid:{value:null},ajaxurl:{value:0},config:{value:0}}});var i=function(){i.superclass.constructor.apply(this,arguments)};e.extend(i,M.core.dragdrop,{initializer:function(t){this.groups=["resource"],this.samenodeclass=n.ACTIVITY,this.parentnodeclass=n.SECTION,this.resourcedraghandle=this.get_drag_handle(M.str.moodle.move,n.EDITINGMOVE,n.ICONCLASS);var r=M.course.format.get_section_selector(e);if(r){r="."+n.COURSECONTENT+" "+r,this.setup_for_section(r);var i=r.slice(n.COURSECONTENT.length+2)+" li."+n.ACTIVITY,s=new e.DD.Delegate({container:"."+n.COURSECONTENT,nodes:i,target:!0,handles:["."+n.EDITINGMOVE],dragConfig:{groups:this.groups}});s.dd.plug(e.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),s.dd.plug(e.Plugin.DDConstrained,{constrain:"#"+n.PAGECONTENT}),s.dd.plug(e.Plugin.DDWinScroll),M.course.coursebase.register_module(this),M.course.dragres=this}},setup_for_section:function(t){e.Node.all(t).each(function(t){var r=t.one("."+n.CONTENT+" ul."+n.SECTION);if(!r){var r=e.Node.create("<ul></ul>");r.addClass(n.SECTION),t.one("."+n.CONTENT+" div."+n.SUMMARY).insert(r,"after")}var i=new e.DD.Drop({node:r,groups:this.groups,padding:"20 0 20 0"});this.setup_for_resource("#"+t.get("id")+" li."+n.ACTIVITY)},this)},setup_for_resource:function(t){e.Node.all(t).each(function(e){var t=e.one("a."+n.EDITINGMOVE);t&&t.replace(this.resourcedraghandle.cloneNode(!0))},this)},get_section_id:function(e){return Number(e.get("id").replace(/section-/i,""))},get_resource_id:function(e){return Number(e.get("id").replace(/module-/i,""))},drag_start:function(e){var t=e.target;t.get("dragNode").setContent(t.get("node").get("innerHTML")),t.get("dragNode").all("img.iconsmall").setStyle("vertical-align","baseline")},drag_dropmiss:function(e){this.drop_hit(e)},drop_hit:function(t){var r=t.drag,i=r.get("node"),s=t.drop.get("node"),o=M.util.add_spinner(e,i.one(n.COMMANDSPAN)),u={},a=this.get("config").pageparams;for(varname in a)u[varname]=a[varname];u.sesskey=M.cfg.sesskey,u.courseId=this.get("courseid"),u["class"]="resource",u.field="move",u.id=Number(this.get_resource_id(i)),u.sectionId=this.get_section_id(s.ancestor(M.course.format.get_section_wrapper(e),!0)),i.next()&&(u.beforeId=Number(this.get_resource_id(i.next())));var f=M.cfg.wwwroot+this.get("ajaxurl");e.io(f,{method:"POST",data:u,on:{start:function(e){this.lock_drag_handle(r,n.EDITINGMOVE),o.show()},success:function(e,t){this.unlock_drag_handle(r,n.EDITINGMOVE),window.setTimeout(function(e){o.hide()},250)},failure:function(e,t){this.ajax_failure(t),this.unlock_drag_handle(r,n.SECTIONHANDLE),o.hide()}},context:this})}},{NAME:"course-dragdrop-resource",ATTRS:{courseid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.course=M.course||{},M.course.init_resource_dragdrop=function(e){new i(e)},M.course.init_section_dragdrop=function(e){new r(e)}},"@VERSION@",{requires:["base","node","io","dom","dd","dd-scroll","moodle-core-dragdrop","moodle-core-notification","moodle-course-coursebase"]});
