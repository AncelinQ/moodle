YUI.add("moodle-comment-comment",function(e,t){var n={COMMENT:".comment",COMMENTREGION:".comment-container",COMMENTAREA:".comment-area",COMMENTLIST:".comment-list",COMMENTTEXT:".comment-area textarea",PAGINATOR:".comment-paging",PAGINATORS:".comment-container .pageno",REMOVEBUTTON:".comment-container .comment-delete",SAVEBUTTON:".comment-container .comment-save",TOGGLEVISIBLITY:".comment-toggle"},r={LOADED:"comments-loaded",COLLAPSED:"collapsed"},i=function(){i.superclass.constructor.apply(this,arguments)};e.extend(i,e.Base,{initializer:function(){e.delegate("click",this.addComment,"body",n.SAVEBUTTON,this),e.delegate("key",this.addComment,"body","down:13,32",n.SAVEBUTTON,this),e.delegate("click",this.deleteComment,"body",n.REMOVEBUTTON,this),e.delegate("key",this.deleteComment,"body","down:13,32",n.REMOVEBUTTON,this),e.delegate("click",this.changePage,"body",n.PAGINATORS,this),e.delegate("key",this.changePage,"body","down:13,32",n.PAGINATORS,this),e.delegate("click",this.toggleCommentVisibility,"body",n.TOGGLEVISIBLITY,this)},changePage:function(e){e.preventDefault();var t=this._getCommentRegion(e.target),r=e.target.ancestor(n.PAGINATORS,!0);if(!r||!r.getData("pageno"))return;this.loadComments(t,{page:r.getData("pageno")})},loadComments:function(t,n){var r={action:"get"};n&&n.page&&(r.page=n.page);var i=this._getIOConfig(t,r);e.io(this.get("api"),i)},toggleCommentVisibility:function(e){e.preventDefault();var t=this._getCommentRegion(e.target),i=t.one(n.COMMENTLIST);i.hasClass(r.LOADED)||(this.loadComments(t,{page:0}),i.addClass(r.LOADED)),t.toggleClass(r.COLLAPSED)},addComment:function(t){t.preventDefault();var r=this._getCommentRegion(t.target),i=r.one(n.COMMENTTEXT);if(!i)return;var s=this._getIOConfig(r,{action:"add",content:i.get("value")});e.io(this.get("api"),s)},deleteComment:function(t){t.preventDefault();var r=this._getCommentRegion(t.target),i=t.target.ancestor(n.COMMENT,!0),s=this;e.use("moodle-core-notification-confirm",function(){var t=new M.core.confirm({question:M.util.get_string("deletecommentcheck","moodle"),modal:!0});t.on("complete-yes",function(){var t=this._getIOConfig(r,{action:"delete",commentid:i.getData("commentid")});e.io(this.get("api"),t)},s),t.show()})},_displayComments:function(t,r){var i=t.one(n.COMMENTLIST);r.appendOnly||i.empty();var s=e.Node.create(r.comments);i.appendChild(s);var o=t.one(n.PAGINATOR);r.pagination&&o&&o.empty().appendChild(r.pagination)},_removeComment:function(e,t){if(!t.commentid)return;var n=e.one('[data-commentid="'+t.commentid+'"]');if(!n)return;n.remove(!0)},_getIOConfig:function(t,n){var r={context:this,on:{complete:this._parseResults},data:{sesskey:M.cfg.sesskey,courseid:t.getData("courseid"),contextid:t.getData("contextid"),component:t.getData("component"),itemid:t.getData("itemid"),area:t.getData("commentarea"),client_id:t.getData("clientid")}};return r.arguments={commentRegion:t},r.data=e.merge(r.data,n),r},_parseResults:function(t,r,i){var s;try{s=e.JSON.parse(r.responseText);if(s.error)return e.use("moodle-core-notification-ajaxException",function(){return new M.core.ajaxException(s)}),!1}catch(o){if(outcome&&outcome.status&&outcome.status>0)return e.use("moodle-core-notification-exception",function(){return(new M.core.exception(o)).show()}),!1}s.action!=="update"&&s.action!=="add"||!s.comments?s.action==="remove"&&s.commentid&&this._removeComment(i.commentRegion,s):(s.action==="add"&&i.commentRegion.one(n.COMMENTTEXT).set("value",""),this._displayComments(i.commentRegion,s));if(typeof s.count!="undefined"){var u=i.commentRegion.one(n.TOGGLEVISIBLITY);u&&u.set("text",M.util.get_string("commentscount","moodle",{linktext:i.commentRegion.getData("linktext"),count:s.count}))}},_getCommentRegion:function(e){return e.ancestor(n.COMMENTREGION,!0)}},{ATTRS:{api:{value:M.cfg.wwwroot+"/comment/comment_ajax.php"}}}),e.namespace("M.comment").comment=function(){return new i(arguments)}},"@VERSION@",{requires:["base","io","event-key"]});
