define(["jquery","core/templates","core/notification","mod_forum/repository","mod_forum/selectors"],function(a,b,c,d,e){var f={THREADED:2,NESTED:3,FLAT_OLDEST_FIRST:1,FLAT_NEWEST_FIRST:-1},g=function(g){g.on("click",e.post.inpageSubmitBtn,function(h){h.preventDefault();var i,j=a(h.currentTarget).parents(e.post.inpageReplyForm).get(0),k=j.elements.post.value.trim(),l=j.elements.reply.value,m=j.elements.subject.value,n=void 0!=j.elements.privatereply&&j.elements.privatereply.checked,o=a(h.currentTarget).parents(e.post.forumContent),p=parseInt(g.find(e.post.modeSelect).get(0).value);k.length&&d.addDiscussionPost(l,m,k,n).then(function(a){var b=a.messages.reduce(function(a,b){return"success"==b.type&&(a+="<p>"+b.message+"</p>"),a},"");return c.addNotification({message:b,type:"success"}),a}).then(function(a){j.reset();var c=a.post;switch(i=c.id,p){case f.THREADED:return b.render("mod_forum/forum_discussion_threaded_post",c);case f.NESTED:return b.render("mod_forum/forum_discussion_nested_post",c);default:return b.render("mod_forum/forum_discussion_post",c)}}).then(function(a,c){var d;return p!=f.FLAT_OLDEST_FIRST&&p!=f.FLAT_NEWEST_FIRST||(d=o.parents(e.post.repliesContainer).children().get(0)),void 0==d&&(d=o.siblings(e.post.repliesContainer).children().get(0)),p==f.FLAT_NEWEST_FIRST?b.prependNodeContents(d,a,c):b.appendNodeContents(d,a,c)}).then(function(){return o.find(e.post.inpageReplyContent).hide()}).then(function(){location.href="#p"+i}).fail(c.exception)})};return{init:function(a){g(a)}}});