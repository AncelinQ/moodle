YUI.add("moodle-mod_quiz-autosave",function(e,t){M.mod_quiz=M.mod_quiz||{},M.mod_quiz.autosave={TINYMCE_DETECTION_DELAY:500,TINYMCE_DETECTION_REPEATS:20,WATCH_HIDDEN_DELAY:1e3,FAILURES_BEFORE_NOTIFY:1,FIRST_SUCCESSFUL_SAVE:-1,SELECTORS:{QUIZ_FORM:"#responseform",VALUE_CHANGE_ELEMENTS:"input, textarea",CHANGE_ELEMENTS:"input, select",HIDDEN_INPUTS:"input[type=hidden]",CONNECTION_ERROR:"#connection-error",CONNECTION_OK:"#connection-ok"},AUTOSAVE_HANDLER:M.cfg.wwwroot+"/mod/quiz/autosave.ajax.php",delay:12e4,form:null,dirty:!1,delayTimer:null,saveTransaction:null,saveFailures:0,editorChangeHandler:null,hiddenFieldValues:{},init:function(t){this.form=e.one(this.SELECTORS.QUIZ_FORM);if(!this.form)return;this.delay=t*1e3,this.form.delegate("valuechange",this.valueChanged,this.SELECTORS.VALUE_CHANGE_ELEMENTS,this),this.form.delegate("change",this.valueChanged,this.SELECTORS.CHANGE_ELEMENTS,this),this.form.on("submit",this.stopAutoSaving,this),this.initTinyMCE(this.TINYMCE_DETECTION_REPEATS),this.saveHiddenFieldValues(),this.watchHiddenFields()},saveHiddenFieldValues:function(){this.form.all(this.SELECTORS.HIDDEN_INPUTS).each(function(e){var t=e.get("name");if(!t)return;this.hiddenFieldValues[t]=e.get("value")},this)},watchHiddenFields:function(){this.detectHiddenFieldChanges(),e.later(this.WATCH_HIDDEN_DELAY,this,this.watchHiddenFields)},detectHiddenFieldChanges:function(){this.form.all(this.SELECTORS.HIDDEN_INPUTS).each(function(e){var t=e.get("name"),n=e.get("value");if(!t)return;if(!(t in this.hiddenFieldValues)||n!==this.hiddenFieldValues[t])this.hiddenFieldValues[t]=n,this.valueChanged({target:e})},this)},initTinyMCE:function(t){if(typeof tinyMCE=="undefined"){t>0&&e.later(this.TINYMCE_DETECTION_DELAY,this,this.initTinyMCE,[t-1]);return}this.editorChangeHandler=e.bind(this.editorChanged,this),tinyMCE.onAddEditor.add(e.bind(this.initTinyMCEEditor,this))},initTinyMCEEditor:function(e,t){t.onChange.add(this.editorChangeHandler),t.onRedo.add(this.editorChangeHandler),t.onUndo.add(this.editorChangeHandler),t.onKeyDown.add(this.editorChangeHandler)},valueChanged:function(e){if(e.target.get("name")==="thispage"||e.target.get("name")==="scrollpos"||e.target.get("name").match(/_:flagged$/))return;this.startSaveTimerIfNecessary()},editorChanged:function(e){this.startSaveTimerIfNecessary()},startSaveTimerIfNecessary:function(){this.dirty=!0;if(this.delayTimer||this.saveTransaction)return;this.startSaveTimer()},startSaveTimer:function(){this.cancelDelay(),this.delayTimer=e.later(this.delay,this,this.saveChanges)},cancelDelay:function(){this.delayTimer&&this.delayTimer!==!0&&this.delayTimer.cancel(),this.delayTimer=null},saveChanges:function(){this.cancelDelay(),this.dirty=!1;if(this.isTimeNearlyOver()){this.stopAutoSaving();return}typeof tinyMCE!="undefined"&&tinyMCE.triggerSave(),this.saveTransaction=e.io(this.AUTOSAVE_HANDLER,{method:"POST",form:{id:this.form},on:{success:this.saveDone,failure:this.saveFailed},context:this})},saveDone:function(){this.saveTransaction=null,this.dirty&&this.startSaveTimer(),this.saveFailures>0?(e.one(this.SELECTORS.CONNECTION_ERROR).hide(),e.one(this.SELECTORS.CONNECTION_OK).show(),this.saveFailures=this.FIRST_SUCCESSFUL_SAVE):this.saveFailures===this.FIRST_SUCCESSFUL_SAVE&&(e.one(this.SELECTORS.CONNECTION_OK).hide(),this.saveFailures=0)},saveFailed:function(){this.saveTransaction=null,this.startSaveTimer(),this.saveFailures=Math.max(1,this.saveFailures+1),this.saveFailures===this.FAILURES_BEFORE_NOTIFY&&(e.one(this.SELECTORS.CONNECTION_ERROR).show(),e.one(this.SELECTORS.CONNECTION_OK).hide())},isTimeNearlyOver:function(){return M.mod_quiz.timer&&M.mod_quiz.timer.endtime&&(new Date).getTime()+2*this.delay>M.mod_quiz.timer.endtime},stopAutoSaving:function(){this.cancelDelay(),this.delayTimer=!0,this.saveTransaction&&this.saveTransaction.abort()}}},"@VERSION@",{requires:["base","node","event","event-valuechange","node-event-delegate","io-form"]});
